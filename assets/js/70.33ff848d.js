(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{459:function(e,t,a){"use strict";a.r(t);var n=a(10),r=Object(n.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"impala问题记录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#impala问题记录"}},[e._v("$")]),e._v(" Impala问题记录")]),e._v(" "),t("h2",{attrs:{id:"python2证书问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#python2证书问题"}},[e._v("$")]),e._v(" python2证书问题")]),e._v(" "),t("p",[e._v("运行Impala的脚本"),t("code",[e._v("infra/python/deps/pip_download.py")]),e._v("下载pip包的时候，本来想配置一个镜像来加速下载，但是配置完"),t("code",[e._v("export PYPI_MIRROR=https://pypi.tuna.tsinghua.edu.cn")]),e._v("之后发现python2访问镜像地址会报错：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('python2 -c \'from urllib2 import urlopen; urlopen("https://mirrors.tuna.tsinghua.edu.cn/help/pypi/")\'\nTraceback (most recent call last):\n  File "<string>", line 1, in <module>\n  File "/usr/lib64/python2.7/urllib2.py", line 154, in urlopen\n    return opener.open(url, data, timeout)\n  File "/usr/lib64/python2.7/urllib2.py", line 431, in open\n    response = self._open(req, data)\n  File "/usr/lib64/python2.7/urllib2.py", line 449, in _open\n    \'_open\', req)\n  File "/usr/lib64/python2.7/urllib2.py", line 409, in _call_chain\n    result = func(*args)\n  File "/usr/lib64/python2.7/urllib2.py", line 1258, in https_open\n    context=self._context, check_hostname=self._check_hostname)\n  File "/usr/lib64/python2.7/urllib2.py", line 1214, in do_open\n    raise URLError(err)\nurllib2.URLError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:618)>\n')])])]),t("p",[e._v("浏览器访问该地址是没有证书相关问题的，换成http协议会自动跳转到https协议的地址。一开始我以为服务器证书有问题，改代码肯定可以，但是有没有不改代码能生效的方法？于是请教了新来的大牛，大牛一顿操作最终帮我解决了问题。")]),e._v(" "),t("p",[e._v("大佬先查看了下环境：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$ cat /etc/redhat-release\nCentOS Linux release 7.9.2009 (Core)\n")])])]),t("p",[e._v("然后用镜像源安装了下requests：")]),e._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("PYPI_MIRROR")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("https://pypi.python.org pip2 "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--user")]),e._v(" requests\n")])])]),t("p",[e._v("又升级了下：")]),e._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("PYPI_MIRROR")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("https://pypi.python.org pip2 "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--user")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--upgrade")]),e._v(" requests\n")])])]),t("p",[e._v("发现没有问题之后又尝试运行了下脚本：")]),e._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[e._v("python2 pip_download.py\n")])])]),t("p",[e._v("然后进python交互终端执行：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('from urllib2 import urlopen; urlopen("https://mirrors.tuna.tsinghua.edu.cn/help/pypi/")\n')])])]),t("p",[e._v("发现还是报错。")]),e._v(" "),t("p",[e._v("然后试探性请求了下镜像源：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$ curl -v > /dev/null  https://pypi.tuna.tsinghua.edu.cn/\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* About to connect() to pypi.tuna.tsinghua.edu.cn port 443 (#0)\n*   Trying 101.6.15.130...\n* Connected to pypi.tuna.tsinghua.edu.cn (101.6.15.130) port 443 (#0)\n* Initializing NSS with certpath: sql:/etc/pki/nssdb\n*   CAfile: /etc/pki/tls/certs/ca-bundle.crt\n  CApath: none\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* SSL connection using TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\n* Server certificate:\n* \tsubject: CN=tuna.tsinghua.edu.cn\n* \tstart date: 9月 26 09:10:36 2021 GMT\n* \texpire date: 12月 25 09:10:35 2021 GMT\n* \tcommon name: tuna.tsinghua.edu.cn\n* \tissuer: CN=R3,O=Let's Encrypt,C=US\n> GET / HTTP/1.1\n> User-Agent: curl/7.29.0\n> Host: pypi.tuna.tsinghua.edu.cn\n> Accept: */*\n> \n< HTTP/1.1 302 Moved Temporarily\n< Server: nginx/1.18.0\n< Date: Thu, 28 Oct 2021 11:17:48 GMT\n< Content-Type: text/html\n< Content-Length: 145\n< Connection: keep-alive\n< Location: https://mirrors.tuna.tsinghua.edu.cn/help/pypi\n< \n{ [data not shown]\n100   145  100   145    0     0    730      0 --:--:-- --:--:-- --:--:--   728\n* Connection #0 to host pypi.tuna.tsinghua.edu.cn left intact\n")])])]),t("p",[e._v("然后继续请求跳转之后的地址：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("curl -v > /dev/null https://mirrors.tuna.tsinghua.edu.cn/help/pypi\n...\ncurl -v > /dev/null https://mirrors.tuna.tsinghua.edu.cn/help/pypi/\n...\n")])])]),t("p",[e._v("查看证书的rpm包：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$ rpm -qa | fgrep cert\nca-certificates-2020.2.41-70.0.el7_8.noarch\n")])])]),t("p",[e._v("列出安装包的文件：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("# rpm -ql ca-certificates\n/etc/pki/ca-trust\n...\n/etc/pki/tls\n/etc/pki/tls/cert.pem\n/etc/pki/tls/certs\n/etc/pki/tls/certs/ca-bundle.crt\n/etc/pki/tls/certs/ca-bundle.trust.crt\n/etc/ssl\n/etc/ssl/certs\n...\n")])])]),t("p",[e._v("使用python3请求相应地址：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("// TODO\n")])])]),t("p",[e._v("查看证书版本信息：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$ rpm -ql ca-certificates -i\nName        : ca-certificates\nVersion     : 2020.2.41\nRelease     : 70.0.el7_8\nArchitecture: noarch\nInstall Date: 2020年11月13日 星期五 09时54分08秒\nGroup       : System Environment/Base\nSize        : 946094\nLicense     : Public Domain\nSignature   : RSA/SHA256, 2020年06月24日 星期三 01时38分15秒, Key ID 24c6a8a7f4a80eb5\nSource RPM  : ca-certificates-2020.2.41-70.0.el7_8.src.rpm\nBuild Date  : 2020年06月23日 星期二 23时39分22秒\nBuild Host  : x86-02.bsys.centos.org\nRelocations : (not relocatable)\nPackager    : CentOS BuildSystem <http://bugs.centos.org>\nVendor      : CentOS\nURL         : http://www.mozilla.org/\nSummary     : The Mozilla CA root certificate bundle\nDescription :\nThis package contains the set of CA certificates chosen by the\nMozilla Foundation for use with the Internet PKI.\n...\n")])])]),t("p",[e._v("查看证书目录：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cd /etc/pki/ca-trust\nll\ncat README\n")])])]),t("p",[e._v("尝试更新证书：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("update-ca-trust\n")])])]),t("p",[e._v("使用strace查看python2使用的证书：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('$ PYPI_MIRROR=https://pypi.tuna.tsinghua.edu.cn strace -f -etrace=open python2 ./pip_download.py\n\n...\n[pid  2846] open("/dev/urandom", O_RDONLY|O_NOCTTY|O_NONBLOCK) = 4\n[pid  2846] open("/etc/pki/tls/cert.pem", O_RDONLY) = 4\n[pid  2849] open("/etc/pki/tls/cert.pem", O_RDONLY) = 4\n[pid  2847] open("/etc/pki/tls/cert.pem", O_RDONLY) = 6\n[pid  2849] open("/etc/nsswitch.conf", O_RDONLY|O_CLOEXEC) = 4\n[pid  2849] open("/etc/host.conf", O_RDONLY|O_CLOEXEC) = 4\n[pid  2849] open("/etc/resolv.conf", O_RDONLY|O_CLOEXEC) = 4\n[pid  2849] open("tls/x86_64/libnss_files.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("tls/libnss_files.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("x86_64/libnss_files.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("libnss_files.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("/opt/jdk/java/jre/lib/amd64/libnss_files.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("/opt/jdk/java/jre/lib/amd64/server/libnss_files.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 4\n[pid  2849] open("/lib64/libnss_files.so.2", O_RDONLY|O_CLOEXEC) = 4\n[pid  2849] open("/etc/hosts", O_RDONLY|O_CLOEXEC) = 4\n[pid  2849] open("tls/x86_64/libnss_dns.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("tls/libnss_dns.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("x86_64/libnss_dns.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("libnss_dns.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("/opt/jdk/java/jre/lib/amd64/libnss_dns.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("/opt/jdk/java/jre/lib/amd64/server/libnss_dns.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[pid  2849] open("/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 4\n[pid  2849] open("/lib64/libnss_dns.so.2", O_RDONLY|O_CLOEXEC) = 4\n[pid  2846] open("/etc/hosts", O_RDONLY|O_CLOEXEC) = 7\n[pid  2848] open("/etc/pki/tls/cert.pem", O_RDONLY) = 6\n[pid  2847] open("/etc/hosts", O_RDONLY|O_CLOEXEC) = 6\n[pid  2848] open("/etc/hosts", O_RDONLY|O_CLOEXEC) = 3\n[pid  2847] open("/etc/gai.conf", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\n[Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:618)\nSleeping for 18 seconds before retrying\n[Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:618)\nSleeping for 19 seconds before retrying\n[Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:618)\nSleeping for 17 seconds before retrying\n[Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:618)\nSleeping for 13 seconds before retrying\nGetting package info from /simple/boto3/\n[Errno 2] No such file or directory: \'/simple/boto3/\'\nSleeping for 155 seconds before retrying\nGetting package info from https://pypi.tuna.tsinghua.edu.cn/simple/boto3/\n[pid  2847] open("/etc/pki/tls/cert.pem", O_RDONLY) = 8\n[pid  2847] open("/etc/hosts", O_RDONLY|O_CLOEXEC) = 8\n[Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:618)\nSleeping for 18 seconds before retrying\nGetting package info from /simple/botocore/\n[Errno 2] No such file or directory: \'/simple/botocore/\'\nSleeping for 108 seconds before retrying\nGetting package info from https://pypi.tuna.tsinghua.edu.cn/simple/botocore/\n[pid  2849] open("/etc/pki/tls/cert.pem", O_RDONLY) = 6\n[pid  2849] open("/etc/hosts", O_RDONLY|O_CLOEXEC) = 6\nGetting package info from https://pypi.tuna.tsinghua.edu.cn/simple/simplejson/\n[pid  2846] open("/etc/pki/tls/cert.pem", O_RDONLY) = 9\n[pid  2846] open("/etc/hosts", O_RDONLY|O_CLOEXEC) = 9\nccd cGetting package info from https://pypi.tuna.tsinghua.edu.cn/simple/allpairs/\n[pid  2848] open("/etc/pki/tls/cert.pem", O_RDONLY) = 10\n[pid  2848] open("/etc/hosts", O_RDONLY|O_CLOEXEC) = 10\nc[Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:618)\nSleeping for 35 seconds before retrying\n[Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:618)\nSleeping for 36 seconds before retrying\nf[Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:618)\nSleeping for 5 seconds before retrying\n')])])]),t("p",[e._v("进入目录：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cd /etc/pki/tls\ncat cert.pem\n")])])]),t("p",[e._v("在基本确定是证书的问题之后，大佬在自己的电脑上继续查找资料和试验，过了以后告诉我，这是python2的bug，系统的证书库里有一个旧的证书 DST Root CA X3，过期时间  Sep 30 14:01:15 2021 GMT，当这个证书存在的时候，python2就会失败。解决办法就是将此证书加入黑名单：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$ cat /etc/pki/ca-trust/source/blacklist/Old-DST-Root-CA-X3.pem\n-----BEGIN CERTIFICATE-----\nMIIDSjCCAjKgAwIBAgIQRK+wgNajJ7qJMDmGLvhAazANBgkqhkiG9w0BAQUFADA/\nMSQwIgYDVQQKExtEaWdpdGFsIFNpZ25hdHVyZSBUcnVzdCBDby4xFzAVBgNVBAMT\nDkRTVCBSb290IENBIFgzMB4XDTAwMDkzMDIxMTIxOVoXDTIxMDkzMDE0MDExNVow\nPzEkMCIGA1UEChMbRGlnaXRhbCBTaWduYXR1cmUgVHJ1c3QgQ28uMRcwFQYDVQQD\nEw5EU1QgUm9vdCBDQSBYMzCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB\nAN+v6ZdQCINXtMxiZfaQguzH0yxrMMpb7NnDfcdAwRgUi+DoM3ZJKuM/IUmTrE4O\nrz5Iy2Xu/NMhD2XSKtkyj4zl93ewEnu1lcCJo6m67XMuegwGMoOifooUMM0RoOEq\nOLl5CjH9UL2AZd+3UWODyOKIYepLYYHsUmu5ouJLGiifSKOeDNoJjj4XLh7dIN9b\nxiqKqy69cK3FCxolkHRyxXtqqzTWMIn/5WgTe1QLyNau7Fqckh49ZLOMxt+/yUFw\n7BZy1SbsOFU5Q9D8/RhcQPGX69Wam40dutolucbY38EVAjqr2m7xPi71XAicPNaD\naeQQmxkqtilX4+U9m5/wAl0CAwEAAaNCMEAwDwYDVR0TAQH/BAUwAwEB/zAOBgNV\nHQ8BAf8EBAMCAQYwHQYDVR0OBBYEFMSnsaR7LHH62+FLkHX/xBVghYkQMA0GCSqG\nSIb3DQEBBQUAA4IBAQCjGiybFwBcqR7uKGY3Or+Dxz9LwwmglSBd49lZRNI+DT69\nikugdB/OEIKcdBodfpga3csTS7MgROSR6cz8faXbauX+5v3gTt23ADq1cEmv8uXr\nAvHRAosZy5Q6XkjEGB5YGV8eAlrwDPGxrancWYaLbumR9YbK+rlmM6pZW87ipxZz\nR8srzJmwN0jP41ZL9c8PDHIyh8bwRLtTcm1D9SZImlJnt1ir/md2cXjbDaJWFBM5\nJDGFoqgCWjBH4d1QB7wCCZAA62RjYJsWvIjJEubSfZGL+T0yjWW06XyxV3bqxbYo\nOb8VZRzI9neWagqNdwvYkQsEjgfbKbYK7p2CNTUQ\n-----END CERTIFICATE-----\n")])])]),t("p",[e._v("然后更新证书：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("update-ca-trust\n")])])]),t("p",[e._v("验证没有问题：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("python2 -c 'from urllib2 import urlopen; urlopen(\"https://mirrors.tuna.tsinghua.edu.cn/help/pypi/\")'\n")])])]),t("p",[e._v("参考：")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://www.openssl.org/blog/blog/2021/09/13/LetsEncryptRootCertExpire/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Old Let’s Encrypt Root Certificate Expiration and OpenSSL 1.0.2"),t("OutboundLink")],1)]),e._v(" "),t("h2",{attrs:{id:"一个jdbc的logintimeout超时问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一个jdbc的logintimeout超时问题"}},[e._v("$")]),e._v(" 一个JDBC的loginTimeout超时问题")]),e._v(" "),t("p",[e._v("线上的Impala遇到一个Socket超时问题，报错堆栈如下：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("org.apache.hive.jdbc.HiveConnection []: Error opening session\norg.apache.thrift.transport.TTransportException: java.net.SocketTimeoutException: Read timed out\n        at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:129)\n        at org.apache.thrift.transport.TTransport.readAll(TTransport.java:86)\n        at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:429)\n        at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:318)\n        at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:219)\n        at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:77)\n        at org.apache.hive.service.cli.thrift.TCLIService$Client.recv_OpenSession(TCLIService.java:156)\n        at org.apache.hive.service.cli.thrift.TCLIService$Client.OpenSession(TCLIService.java:143)\n        at org.apache.hive.jdbc.HiveConnection.openSession(HiveConnection.java:464)\n        at org.apache.hive.jdbc.HiveConnection.<init>(HiveConnection.java:181)\n        at org.apache.hive.jdbc.HiveDriver.connect(HiveDriver.java:105)\n        at java.sql.DriverManager.getConnection(DriverManager.java:664)\n        at java.sql.DriverManager.getConnection(DriverManager.java:270)\nCaused by: java.net.SocketTimeoutException: Read timed out\n        at java.net.SocketInputStream.socketRead0(Native Method)\n        at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)\n")])])]),t("p",[e._v("看了下日志，大约30s就超时了，通常来说Impala的查询的执行时间有可能是分钟级别的，这么短的超时时间明显不对劲，咨询了下大佬Java的Socket超时有可能提前结束吗，大佬的答案是否定的。因为我们用的是Hive JDBC Driver，看了一下Socket超时时间是在thrift的TSocket构造函数里设置的：")]),e._v(" "),t("p",[e._v("https://github.com/apache/hive/blob/rel/release-3.1.3/common/src/java/org/apache/hadoop/hive/common/auth/HiveAuthUtils.java#L45")]),e._v(" "),t("p",[e._v("而 loginTimeout 的取值就有点二了，是从DriverManager的静态方法获取的：")]),e._v(" "),t("p",[e._v("https://github.com/apache/hive/blob/rel/release-3.1.3/jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java#L806")]),e._v(" "),t("p",[e._v("这也就意味着 loginTimeout 的设置没法做到很好的隔离性。用 arthas 看了一下DriverManager.logintimeout的值，还真的是 30s：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("[arthas@21070]$ getstatic java.sql.DriverManager loginTimeout\nfield: loginTimeout\n@Integer[30]\nAffect(row-cnt:1) cost in 19ms\n")])])]),t("p",[e._v("而这30s的始作俑者猜一下也大概是跟JDBC有关的其他Driver或者连接池，最终发现是连接MySQL用的HikariCP连接池里做的手脚：")]),e._v(" "),t("p",[e._v("https://github.com/brettwooldridge/HikariCP/blob/HikariCP-4.0.3/src/main/java/com/zaxxer/hikari/pool/PoolBase.java#L114")]),e._v(" "),t("p",[e._v("https://github.com/brettwooldridge/HikariCP/blob/HikariCP-4.0.3/src/main/java/com/zaxxer/hikari/pool/PoolBase.java#L343")]),e._v(" "),t("p",[e._v("https://github.com/brettwooldridge/HikariCP/blob/HikariCP-4.0.3/src/main/java/com/zaxxer/hikari/pool/PoolBase.java#L624")]),e._v(" "),t("p",[e._v("https://github.com/brettwooldridge/HikariCP/blob/HikariCP-4.0.3/src/main/java/com/zaxxer/hikari/util/DriverDataSource.java#L154")]),e._v(" "),t("p",[e._v("这可能算是 JDBC 设计上的一个缺陷吧，全局的静态变量就没法做到线程隔离了，至于 HikariCP 也遵循这个规则的原因就不得而知了。")]),e._v(" "),t("p",[e._v("Hive 的 master 分支其实已经修复了这个问题，修复的方式是由一个新增的 sessionVar 变量来控制，但是Hive JDBC迟迟没有发布正式的版本，最后的修复方法只能是backports了"),t("a",{attrs:{href:"https://github.com/apache/hive/pull/1611",target:"_blank",rel:"noopener noreferrer"}},[e._v("HIVE-12371"),t("OutboundLink")],1),e._v("的 patch了。")]),e._v(" "),t("h3",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[e._v("$")]),e._v(" 参考")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://issues.apache.org/jira/browse/HIVE-12371",target:"_blank",rel:"noopener noreferrer"}},[e._v("HIVE-12371 Adding a timeout connection parameter for JDBC"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);