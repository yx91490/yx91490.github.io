(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{502:function(v,_,t){"use strict";t.r(_);var a=t(18),l=Object(a.a)({},(function(){var v=this,_=v._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[_("h1",{attrs:{id:"《快手短视频打造高稳定千亿级别对象存储平台》笔记"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#《快手短视频打造高稳定千亿级别对象存储平台》笔记"}},[v._v("$")]),v._v(" 《快手短视频打造高稳定千亿级别对象存储平台》笔记")]),v._v(" "),_("h3",{attrs:{id:"业务需求"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#业务需求"}},[v._v("$")]),v._v(" 业务需求")]),v._v(" "),_("h4",{attrs:{id:"业务规模"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#业务规模"}},[v._v("$")]),v._v(" 业务规模")]),v._v(" "),_("p",[v._v("1.3亿日活，70亿库存，日播放150亿，ugc1500万：千亿对象，百PB存储")]),v._v(" "),_("h4",{attrs:{id:"业务需求与解决思路"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#业务需求与解决思路"}},[v._v("$")]),v._v(" 业务需求与解决思路")]),v._v(" "),_("p",[v._v("海量数据 =>  小数据合并，长短视频 =>  流式读写，高可扩展 =>  扩展集群而非扩展机器（避免数据迁移io对在线业务的影响），高可用 =>  快速发现+恢复+Failover，高性能 =>  数据缓存，最终一致 =>  数据读写模式控制")]),v._v(" "),_("h4",{attrs:{id:"业务流程"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#业务流程"}},[v._v("$")]),v._v(" 业务流程")]),v._v(" "),_("ol",[_("li",[v._v("上传视频API层")]),v._v(" "),_("li",[v._v("生成对象ID")]),v._v(" "),_("li",[v._v("写入对象存储BlobStore，同时发送通知事件")]),v._v(" "),_("li",[v._v("转码、去重等服务从BlobStore读取")])]),v._v(" "),_("h3",{attrs:{id:"架构与实现"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#架构与实现"}},[v._v("$")]),v._v(" 架构与实现")]),v._v(" "),_("p",[_("strong",[v._v("BlobStore层次架构图")])]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("层次")]),v._v(" "),_("th",[v._v("功能")]),v._v(" "),_("th",[v._v("备注")])])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("数据层")]),v._v(" "),_("td",[v._v("对象数据存储")]),v._v(" "),_("td")]),v._v(" "),_("tr",[_("td",[v._v("索引层")]),v._v(" "),_("td",[v._v("对象元信息与索引")]),v._v(" "),_("td")]),v._v(" "),_("tr",[_("td",[v._v("缓存层")]),v._v(" "),_("td",[v._v("热数据cache")]),v._v(" "),_("td",[v._v("写入饥饿")])]),v._v(" "),_("tr",[_("td",[v._v("逻辑层")]),v._v(" "),_("td",[v._v("业务逻辑：数据存储，索引，扩展，failover")]),v._v(" "),_("td",[v._v("gateway")])]),v._v(" "),_("tr",[_("td",[v._v("接入层")]),v._v(" "),_("td",[v._v("http service")]),v._v(" "),_("td",[v._v("gateway")])])])]),v._v(" "),_("p",[_("strong",[v._v("BlobStore写入流程")])]),v._v(" "),_("ol",[_("li",[v._v("client通过zookeeper服务发现gateway服务")]),v._v(" "),_("li",[v._v("gateway写数据")]),v._v(" "),_("li",[v._v("gateway更新索引")]),v._v(" "),_("li",[v._v("gateway写入数据缓存")])]),v._v(" "),_("p",[_("strong",[v._v("BlobStore读取流程")])]),v._v(" "),_("ol",[_("li",[v._v("服务发现")]),v._v(" "),_("li",[v._v("查询缓存")]),v._v(" "),_("li",[v._v("查询索引")]),v._v(" "),_("li",[v._v("获取对象数据")])]),v._v(" "),_("p",[_("strong",[v._v("BlobStore双机房写流程")])]),v._v(" "),_("ol",[_("li",[v._v("gateway数据双机房同步双写")]),v._v(" "),_("li",[v._v("HBase索引异步复制，回落读实现最终一致性")]),v._v(" "),_("li",[v._v("同步更新cache")])]),v._v(" "),_("p",[_("strong",[v._v("BlobStore双机房读流程")])]),v._v(" "),_("ol",[_("li",[v._v("读cache")]),v._v(" "),_("li",[v._v("读hbase索引，miss则去另一个机房读")]),v._v(" "),_("li",[v._v("读hdfs")])]),v._v(" "),_("h3",{attrs:{id:"问题与解决"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#问题与解决"}},[v._v("$")]),v._v(" 问题与解决")]),v._v(" "),_("p",[_("strong",[v._v("高可扩展")])]),v._v(" "),_("ol",[_("li",[v._v("gateway无状态")]),v._v(" "),_("li",[v._v("HBase扩容机器(容量可控，业务低峰，限速扩容)")]),v._v(" "),_("li",[v._v("HDFS扩容集群，避免扩容机器时数据迁移对在线业务的影响")])]),v._v(" "),_("p",[_("strong",[v._v("高可用")])]),v._v(" "),_("ol",[_("li",[v._v("故障类型\n"),_("ul",[_("li",[v._v("进程异常退出(立即感知)")]),v._v(" "),_("li",[v._v("机器宕机（会出现超时）")])])]),v._v(" "),_("li",[v._v("快速发现\n"),_("ul",[_("li",[v._v("宕机发现服务")]),v._v(" "),_("li",[v._v("HDFS/HBase")])])]),v._v(" "),_("li",[v._v("快速恢复\n"),_("ul",[_("li",[v._v("HDFS/HBase")])])]),v._v(" "),_("li",[v._v("服务熔断\n"),_("ul",[_("li",[v._v("Gateway单点故障")]),v._v(" "),_("li",[v._v("HDFS/HBase单点故障")])])])]),v._v(" "),_("p",[_("strong",[v._v("宕机发现服务(Hawk)")])]),v._v(" "),_("ol",[_("li",[v._v("解决机器宕机问题")]),v._v(" "),_("li",[v._v("主从结构")]),v._v(" "),_("li",[v._v("master:\n"),_("ol",[_("li",[v._v("接收node down sniffer关于监听节点的注册请求，将节点通过心跳传递给worker")]),v._v(" "),_("li",[v._v("跟worker保持相同的逻辑时钟")]),v._v(" "),_("li",[v._v("多数派判定宕机（n-1）")])])]),v._v(" "),_("li",[v._v("worker:\n"),_("ol",[_("li",[v._v("跟master保持心跳，获取监听节点")]),v._v(" "),_("li",[v._v("跟master保持心跳,获取逻辑时钟")]),v._v(" "),_("li",[v._v("周期性检查节点宕机情况（ping check）")])])])]),v._v(" "),_("p",[_("strong",[v._v("HDFS服务快速恢复思路")])]),v._v(" "),_("ol",[_("li",[v._v("服务进程异常退出：fast-fail(1s内)")]),v._v(" "),_("li",[v._v("机器宕机：大量时间消耗在超时等待上，解决思路：\n"),_("ol",[_("li",[v._v("冗余读（HedgeRead）")]),v._v(" "),_("li",[v._v("并行写(ParallelWrite)")])])])]),v._v(" "),_("p",[_("strong",[v._v("HBase服务快速恢复思路")])]),v._v(" "),_("ol",[_("li",[v._v("服务进程异常退出：fast-fail(快速发现1s内，恢复10s内)")]),v._v(" "),_("li",[v._v("大量时间消耗在超时等待上，解决思路：\n"),_("ol",[_("li",[v._v("hawk接入，快速发现")]),v._v(" "),_("li",[v._v("基于ping check规避宕机节点策略")]),v._v(" "),_("li",[v._v("调优参数提高并行度")])])])]),v._v(" "),_("p",[_("strong",[v._v("Failover与服务熔断")])]),v._v(" "),_("ol",[_("li",[v._v("请求异常，快速切换到其他镜像服务")]),v._v(" "),_("li",[v._v("权重降权的熔断策略")])]),v._v(" "),_("h3",{attrs:{id:"数据一致性"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#数据一致性"}},[v._v("$")]),v._v(" 数据一致性")]),v._v(" "),_("ol",[_("li",[v._v("双集群同步双写，单写失败跳过")]),v._v(" "),_("li",[v._v("异步实时数据补齐")]),v._v(" "),_("li",[v._v("周期性数据一致性校验")])]),v._v(" "),_("h3",{attrs:{id:"参考"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[v._v("$")]),v._v(" 参考")]),v._v(" "),_("p",[_("a",{attrs:{href:"https://myslide.cn/slides/10006#",target:"_blank",rel:"noopener noreferrer"}},[v._v("如何快速打造高稳定千亿级别对象存储平台V7 快手 赵健博"),_("OutboundLink")],1)]),v._v(" "),_("p",[_("a",{attrs:{href:"https://v.qq.com/x/page/i08232qb5qq.html",target:"_blank",rel:"noopener noreferrer"}},[v._v("如何快速打造高稳定千亿级别对象存储平台"),_("OutboundLink")],1)])])}),[],!1,null,null,null);_.default=l.exports}}]);