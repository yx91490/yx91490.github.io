(window.webpackJsonp=window.webpackJsonp||[]).push([[195],{614:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"操作系统ulimit"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#操作系统ulimit"}},[s._v("$")]),s._v(" 操作系统ulimit")]),s._v(" "),t("h2",{attrs:{id:"ulimit-a"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ulimit-a"}},[s._v("$")]),s._v(" ulimit -a")]),s._v(" "),t("p",[s._v("执行"),t("code",[s._v("ulimit -a")]),s._v("查看所有值：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("core "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" size          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("blocks, -c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\ndata seg size           "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\nscheduling priority             "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" size               "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("blocks, -f"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\npending signals                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("514562")]),s._v("\nmax locked memory       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\nmax memory size         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" files                      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\npipe size            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),s._v(" bytes, -p"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\nPOSIX message queues     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes, -q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("819200")]),s._v("\nreal-time priority              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-r"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nstack size              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10240")]),s._v("\ncpu "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("seconds, -t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\nmax user processes              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-u"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10240")]),s._v("\nvirtual memory          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" locks                      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\n")])])]),t("h2",{attrs:{id:"ulimit-u-max-user-processes"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ulimit-u-max-user-processes"}},[s._v("$")]),s._v(" ulimit -u (max user processes)")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 内核可以分配的最大进程描述符")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/sys/kernel/pid_max\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sysctl")]),s._v(" kernel.pid_max\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 内核task_struct 中包含的最大元素数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/sys/kernel/threads-max\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 单个用户可用的最大进程数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-u")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v("  /etc/security/limits.conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/security/limits.d/20-nproc.conf\n")])])]),t("h2",{attrs:{id:"ulimit-n-open-files"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ulimit-n-open-files"}},[s._v("$")]),s._v(" ulimit -n (open files)")]),s._v(" "),t("p",[s._v("有时候程序会报错“too many files open”：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Caused by: java.io.IOException: 打开的文件过多\n\tat sun.nio.ch.IOUtil.makePipe(Native Method)\n\tat sun.nio.ch.EPollSelectorImpl.<init>(EPollSelectorImpl.java:65)\n\tat sun.nio.ch.EPollSelectorProvider.openSelector(EPollSelectorProvider.java:36)\n\tat io.netty.channel.nio.NioEventLoop.openSelector(NioEventLoop.java:166)\n\t... 29 more\n")])])]),t("h3",{attrs:{id:"查看限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看限制"}},[s._v("$")]),s._v(" 查看限制")]),s._v(" "),t("p",[s._v("从Linux内核的角度获取当前打开文件的数量：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/sys/fs/file-nr\n")])])]),t("p",[s._v("查看系统的最大打开文件数：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/sys/fs/file-max\n")])])]),t("p",[s._v("查看每个进程的最大打开文件数：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v("\n")])])]),t("p",[s._v("运行中进程的limits的查看:")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/limits\n")])])]),t("h3",{attrs:{id:"更改限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#更改限制"}},[s._v("$")]),s._v(" 更改限制")]),s._v(" "),t("p",[s._v("更改每个进程的最大打开文件数："),t("code",[s._v("ulimit -n 4096")])]),s._v(" "),t("p",[s._v("更改每每个系统的最大打开文件数："),t("code",[s._v("echo 800000 > /proc/sys/fs/file-max")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("硬限制是实际的限制，而软限制，是warnning限制，只会做出warning\n其实ulimit命令本身就有分软硬设置，加-H就是硬，加-S就是软\n默认显示的是软限制，如果修改的时候没有加上的话，就是两个一起改\n")])])]),t("p",[s._v("修改"),t("code",[s._v("/etc/security/limits.conf")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("soft nofile "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("\nhard nofile "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32768")]),s._v("\n")])])]),t("h3",{attrs:{id:"查看进程文件打开数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看进程文件打开数"}},[s._v("$")]),s._v(" 查看进程文件打开数")]),s._v(" "),t("p",[s._v("查看进程文件打开数方式一：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /proc/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/fd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\n")])])]),t("p",[s._v("查看进程文件打开数方式二：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("lsof")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\n")])])]),t("p",[s._v("进程按打开句柄数倒序排序（第一列是打开的文件句柄数量，第二列是进程号）：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("lsof")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sort")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("uniq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sort")]),s._v(" -nr"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v("\n")])])]),t("h3",{attrs:{id:"查看进程的线程数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看进程的线程数"}},[s._v("$")]),s._v(" 查看进程的线程数")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/status "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" Threads\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /proc/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/task "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\n")])])]),t("h3",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("$")]),s._v(" 参考")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://qastack.cn/unix/36841/why-is-number-of-open-files-limited-in-linux",target:"_blank",rel:"noopener noreferrer"}},[s._v("为什么在Linux中限制打开文件的数量？"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://yq.aliyun.com/articles/243784",target:"_blank",rel:"noopener noreferrer"}},[s._v("Linux下查看进程打开的文件句柄数和如何修改"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://www.ibm.com/support/pages/%E5%A6%82%E4%BD%95%E8%AF%8A%E6%96%AD-too-many-open-files-%E9%97%AE%E9%A2%98%EF%BC%9F",target:"_blank",rel:"noopener noreferrer"}},[s._v("如何诊断 'TOO MANY OPEN FILES' 问题"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://juejin.im/post/5d4cf32f6fb9a06b1d21312c",target:"_blank",rel:"noopener noreferrer"}},[s._v("第3期：Too many open files以及ulimit的探讨"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=n.exports}}]);