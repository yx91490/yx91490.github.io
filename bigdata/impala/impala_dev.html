<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Impala开发笔记 | yx91490的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.webp">
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QQHZM2VLM0');
window.addEventListener('load', function(){ var s = document.createElement('script'); s.src = "https://www.googletagmanager.com/gtag/js?id=G-QQHZM2VLM0"; document.body.appendChild(s); });</script>
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6781d2ac2dff1f3b278518419b4d4deb";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <meta name="description" content="java, 大数据(hadoop, sqoop, kylin, zeppelin)相关技术, 工作经验记录">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="google-site-verification" content="j1Gm2ZeMV3D7mPiI08fpx91dEOSlhCAJjD4vy_pSroQ">
    <meta name="baidu-site-verification" content="4z2bGbjYMB">
    
    <link rel="preload" href="/assets/css/0.styles.003598ab.css" as="style"><link rel="preload" href="/assets/js/app.cca92ec1.js" as="script"><link rel="preload" href="/assets/js/2.33a0ea92.js" as="script"><link rel="preload" href="/assets/js/26.9880f9e1.js" as="script"><link rel="prefetch" href="/assets/js/10.88dc31de.js"><link rel="prefetch" href="/assets/js/100.c998a55e.js"><link rel="prefetch" href="/assets/js/101.5cfd51aa.js"><link rel="prefetch" href="/assets/js/102.214e1a22.js"><link rel="prefetch" href="/assets/js/103.0c1319a5.js"><link rel="prefetch" href="/assets/js/104.fe41e908.js"><link rel="prefetch" href="/assets/js/105.835ec954.js"><link rel="prefetch" href="/assets/js/106.485c41b1.js"><link rel="prefetch" href="/assets/js/107.71294c8a.js"><link rel="prefetch" href="/assets/js/108.97625bcf.js"><link rel="prefetch" href="/assets/js/109.7f81dde2.js"><link rel="prefetch" href="/assets/js/11.f800eaba.js"><link rel="prefetch" href="/assets/js/110.ba25321a.js"><link rel="prefetch" href="/assets/js/111.d86fc7ad.js"><link rel="prefetch" href="/assets/js/112.c5c2ff0a.js"><link rel="prefetch" href="/assets/js/113.f40affe4.js"><link rel="prefetch" href="/assets/js/114.ddb09731.js"><link rel="prefetch" href="/assets/js/115.01358cc7.js"><link rel="prefetch" href="/assets/js/116.9c9657aa.js"><link rel="prefetch" href="/assets/js/117.49949d00.js"><link rel="prefetch" href="/assets/js/118.8b766b94.js"><link rel="prefetch" href="/assets/js/119.624977af.js"><link rel="prefetch" href="/assets/js/12.4ee70420.js"><link rel="prefetch" href="/assets/js/120.6dea24be.js"><link rel="prefetch" href="/assets/js/121.3a39d543.js"><link rel="prefetch" href="/assets/js/122.d8029842.js"><link rel="prefetch" href="/assets/js/123.7b65a226.js"><link rel="prefetch" href="/assets/js/124.5b112e40.js"><link rel="prefetch" href="/assets/js/125.b6d6cad0.js"><link rel="prefetch" href="/assets/js/126.91158f8e.js"><link rel="prefetch" href="/assets/js/127.1309dec5.js"><link rel="prefetch" href="/assets/js/128.0f59dd65.js"><link rel="prefetch" href="/assets/js/129.eae38df4.js"><link rel="prefetch" href="/assets/js/13.1f463022.js"><link rel="prefetch" href="/assets/js/130.5f9010d8.js"><link rel="prefetch" href="/assets/js/131.45ca18d7.js"><link rel="prefetch" href="/assets/js/132.8dd35180.js"><link rel="prefetch" href="/assets/js/133.2f15e5d1.js"><link rel="prefetch" href="/assets/js/134.10f07dc8.js"><link rel="prefetch" href="/assets/js/135.10fd9a65.js"><link rel="prefetch" href="/assets/js/136.9a038875.js"><link rel="prefetch" href="/assets/js/137.b62ddaad.js"><link rel="prefetch" href="/assets/js/138.d86f2a27.js"><link rel="prefetch" href="/assets/js/139.8af6b097.js"><link rel="prefetch" href="/assets/js/14.8c75b28b.js"><link rel="prefetch" href="/assets/js/140.7a1b7e4c.js"><link rel="prefetch" href="/assets/js/141.2462a01b.js"><link rel="prefetch" href="/assets/js/142.6f27b6ce.js"><link rel="prefetch" href="/assets/js/143.0d7c6e4a.js"><link rel="prefetch" href="/assets/js/144.d242402b.js"><link rel="prefetch" href="/assets/js/145.c6ed47c0.js"><link rel="prefetch" href="/assets/js/146.b9cc70d6.js"><link rel="prefetch" href="/assets/js/147.ce0b566e.js"><link rel="prefetch" href="/assets/js/148.4045ac87.js"><link rel="prefetch" href="/assets/js/149.a4687b31.js"><link rel="prefetch" href="/assets/js/15.7fa338d3.js"><link rel="prefetch" href="/assets/js/150.a0fe1a64.js"><link rel="prefetch" href="/assets/js/151.397bdc87.js"><link rel="prefetch" href="/assets/js/152.986c7dd4.js"><link rel="prefetch" href="/assets/js/153.124ede5e.js"><link rel="prefetch" href="/assets/js/154.6c6b9430.js"><link rel="prefetch" href="/assets/js/155.56b08148.js"><link rel="prefetch" href="/assets/js/156.5a50d816.js"><link rel="prefetch" href="/assets/js/157.29a94216.js"><link rel="prefetch" href="/assets/js/158.a2f43f2a.js"><link rel="prefetch" href="/assets/js/159.07fc6ecd.js"><link rel="prefetch" href="/assets/js/16.8e9b4d97.js"><link rel="prefetch" href="/assets/js/160.1a2e1d48.js"><link rel="prefetch" href="/assets/js/161.f1f9a379.js"><link rel="prefetch" href="/assets/js/162.3a124735.js"><link rel="prefetch" href="/assets/js/163.cecba60e.js"><link rel="prefetch" href="/assets/js/164.d76300d3.js"><link rel="prefetch" href="/assets/js/165.9fc2b210.js"><link rel="prefetch" href="/assets/js/166.d7f14240.js"><link rel="prefetch" href="/assets/js/167.55baad2a.js"><link rel="prefetch" href="/assets/js/168.db32885f.js"><link rel="prefetch" href="/assets/js/169.3afa564f.js"><link rel="prefetch" href="/assets/js/17.df142171.js"><link rel="prefetch" href="/assets/js/170.67409a30.js"><link rel="prefetch" href="/assets/js/171.a464f72a.js"><link rel="prefetch" href="/assets/js/172.4ee3263f.js"><link rel="prefetch" href="/assets/js/173.74441240.js"><link rel="prefetch" href="/assets/js/174.c10008ea.js"><link rel="prefetch" href="/assets/js/175.b8dfc06d.js"><link rel="prefetch" href="/assets/js/176.7b8559cc.js"><link rel="prefetch" href="/assets/js/177.ed43ec52.js"><link rel="prefetch" href="/assets/js/178.445e5c95.js"><link rel="prefetch" href="/assets/js/179.0aed4a6a.js"><link rel="prefetch" href="/assets/js/18.dd640a17.js"><link rel="prefetch" href="/assets/js/180.b1e696d6.js"><link rel="prefetch" href="/assets/js/181.e3fd202d.js"><link rel="prefetch" href="/assets/js/182.508abbda.js"><link rel="prefetch" href="/assets/js/183.10c813c1.js"><link rel="prefetch" href="/assets/js/184.86c84df0.js"><link rel="prefetch" href="/assets/js/185.0032af56.js"><link rel="prefetch" href="/assets/js/186.6bfc024c.js"><link rel="prefetch" href="/assets/js/187.2dad1931.js"><link rel="prefetch" href="/assets/js/188.a64b6022.js"><link rel="prefetch" href="/assets/js/189.ee740f2f.js"><link rel="prefetch" href="/assets/js/19.a083ae30.js"><link rel="prefetch" href="/assets/js/190.72f4677e.js"><link rel="prefetch" href="/assets/js/191.f09c824d.js"><link rel="prefetch" href="/assets/js/192.16c0fee8.js"><link rel="prefetch" href="/assets/js/193.5396a304.js"><link rel="prefetch" href="/assets/js/194.de5f9b10.js"><link rel="prefetch" href="/assets/js/195.4529b7d5.js"><link rel="prefetch" href="/assets/js/196.e2fa1ed3.js"><link rel="prefetch" href="/assets/js/197.62142903.js"><link rel="prefetch" href="/assets/js/198.6dff64af.js"><link rel="prefetch" href="/assets/js/199.3dc8bdca.js"><link rel="prefetch" href="/assets/js/20.b61ed994.js"><link rel="prefetch" href="/assets/js/200.2320f437.js"><link rel="prefetch" href="/assets/js/201.ede1a738.js"><link rel="prefetch" href="/assets/js/202.520f2c99.js"><link rel="prefetch" href="/assets/js/203.0135621c.js"><link rel="prefetch" href="/assets/js/204.6e72eb68.js"><link rel="prefetch" href="/assets/js/21.6763e214.js"><link rel="prefetch" href="/assets/js/22.f95812a0.js"><link rel="prefetch" href="/assets/js/23.a1a17881.js"><link rel="prefetch" href="/assets/js/24.bfdeab55.js"><link rel="prefetch" href="/assets/js/25.321836a8.js"><link rel="prefetch" href="/assets/js/27.e972e44d.js"><link rel="prefetch" href="/assets/js/28.a94f3322.js"><link rel="prefetch" href="/assets/js/29.cabf3062.js"><link rel="prefetch" href="/assets/js/3.83ed7666.js"><link rel="prefetch" href="/assets/js/30.18ad4318.js"><link rel="prefetch" href="/assets/js/31.862218ce.js"><link rel="prefetch" href="/assets/js/32.65e87763.js"><link rel="prefetch" href="/assets/js/33.b338d69d.js"><link rel="prefetch" href="/assets/js/34.d2258744.js"><link rel="prefetch" href="/assets/js/35.ea6b626d.js"><link rel="prefetch" href="/assets/js/36.78839f69.js"><link rel="prefetch" href="/assets/js/37.a8bd031a.js"><link rel="prefetch" href="/assets/js/38.270b1c97.js"><link rel="prefetch" href="/assets/js/39.89e8fb86.js"><link rel="prefetch" href="/assets/js/4.a1be65f2.js"><link rel="prefetch" href="/assets/js/40.228a7ab1.js"><link rel="prefetch" href="/assets/js/41.8303865e.js"><link rel="prefetch" href="/assets/js/42.cd44fba4.js"><link rel="prefetch" href="/assets/js/43.42293d56.js"><link rel="prefetch" href="/assets/js/44.f482c5c8.js"><link rel="prefetch" href="/assets/js/45.f32430e8.js"><link rel="prefetch" href="/assets/js/46.15535ce1.js"><link rel="prefetch" href="/assets/js/47.d47da5a9.js"><link rel="prefetch" href="/assets/js/48.0d61742a.js"><link rel="prefetch" href="/assets/js/49.969c8240.js"><link rel="prefetch" href="/assets/js/5.8ca98d78.js"><link rel="prefetch" href="/assets/js/50.86a2c0c0.js"><link rel="prefetch" href="/assets/js/51.c863024b.js"><link rel="prefetch" href="/assets/js/52.58df719d.js"><link rel="prefetch" href="/assets/js/53.527c7dbc.js"><link rel="prefetch" href="/assets/js/54.9328e081.js"><link rel="prefetch" href="/assets/js/55.43d92349.js"><link rel="prefetch" href="/assets/js/56.4962691f.js"><link rel="prefetch" href="/assets/js/57.9ae0e6c5.js"><link rel="prefetch" href="/assets/js/58.d0e15e90.js"><link rel="prefetch" href="/assets/js/59.5c5ecd6a.js"><link rel="prefetch" href="/assets/js/6.82b8d11d.js"><link rel="prefetch" href="/assets/js/60.d8500f38.js"><link rel="prefetch" href="/assets/js/61.c5de4cd7.js"><link rel="prefetch" href="/assets/js/62.a156a433.js"><link rel="prefetch" href="/assets/js/63.00958f2f.js"><link rel="prefetch" href="/assets/js/64.f7beff08.js"><link rel="prefetch" href="/assets/js/65.ee18a02e.js"><link rel="prefetch" href="/assets/js/66.cad7020b.js"><link rel="prefetch" href="/assets/js/67.50ec1796.js"><link rel="prefetch" href="/assets/js/68.b0efb28e.js"><link rel="prefetch" href="/assets/js/69.c9f3619c.js"><link rel="prefetch" href="/assets/js/7.6275540b.js"><link rel="prefetch" href="/assets/js/70.f8c778c6.js"><link rel="prefetch" href="/assets/js/71.96f901e9.js"><link rel="prefetch" href="/assets/js/72.b71cf51e.js"><link rel="prefetch" href="/assets/js/73.288d2d54.js"><link rel="prefetch" href="/assets/js/74.da8aba33.js"><link rel="prefetch" href="/assets/js/75.c0e2f6a4.js"><link rel="prefetch" href="/assets/js/76.8293fd6e.js"><link rel="prefetch" href="/assets/js/77.2f64f5e9.js"><link rel="prefetch" href="/assets/js/78.71cc24cb.js"><link rel="prefetch" href="/assets/js/79.76385e06.js"><link rel="prefetch" href="/assets/js/8.1661bdd8.js"><link rel="prefetch" href="/assets/js/80.2414a88f.js"><link rel="prefetch" href="/assets/js/81.fc3bd703.js"><link rel="prefetch" href="/assets/js/82.174a8096.js"><link rel="prefetch" href="/assets/js/83.a9f5f337.js"><link rel="prefetch" href="/assets/js/84.79f6137c.js"><link rel="prefetch" href="/assets/js/85.a104e15e.js"><link rel="prefetch" href="/assets/js/86.10c9e45f.js"><link rel="prefetch" href="/assets/js/87.ab3edbf9.js"><link rel="prefetch" href="/assets/js/88.0bb7b3a7.js"><link rel="prefetch" href="/assets/js/89.9477ad7d.js"><link rel="prefetch" href="/assets/js/9.a4f1574b.js"><link rel="prefetch" href="/assets/js/90.ae014a9b.js"><link rel="prefetch" href="/assets/js/91.a7cc2934.js"><link rel="prefetch" href="/assets/js/92.a8f3563c.js"><link rel="prefetch" href="/assets/js/93.194447ab.js"><link rel="prefetch" href="/assets/js/94.ff816371.js"><link rel="prefetch" href="/assets/js/95.6c444add.js"><link rel="prefetch" href="/assets/js/96.c6f6c5a0.js"><link rel="prefetch" href="/assets/js/97.0f5c685c.js"><link rel="prefetch" href="/assets/js/98.da3fd65d.js"><link rel="prefetch" href="/assets/js/99.a9f2de79.js">
    <link rel="stylesheet" href="/assets/css/0.styles.003598ab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">yx91490的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/" class="nav-link">
  Java开发
</a></div><div class="nav-item"><a href="/bigdata/" class="nav-link router-link-active">
  大数据
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="contactMe" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="contactMe" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sql/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/clang/" class="nav-link">
  C语言
</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/diagram/" class="nav-link">
  图示速查
</a></li><li class="dropdown-item"><!----> <a href="/collection/" class="nav-link">
  资料收藏
</a></li><li class="dropdown-item"><!----> <a href="/cs/" class="nav-link">
  计算机科学
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/yx91490" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/yx91490/yx91490.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="nav-link external">
  给我留言
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/" class="nav-link">
  Java开发
</a></div><div class="nav-item"><a href="/bigdata/" class="nav-link router-link-active">
  大数据
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="contactMe" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="contactMe" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sql/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/clang/" class="nav-link">
  C语言
</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/diagram/" class="nav-link">
  图示速查
</a></li><li class="dropdown-item"><!----> <a href="/collection/" class="nav-link">
  资料收藏
</a></li><li class="dropdown-item"><!----> <a href="/cs/" class="nav-link">
  计算机科学
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/yx91490" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/yx91490/yx91490.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="nav-link external">
  给我留言
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Zeppelin</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/zeppelin/heart_diease_dataset.html" class="sidebar-link">心脏病预测数据</a></li><li><a href="/bigdata/zeppelin/zeppelin_bugs.html" class="sidebar-link">zeppelin使用趟坑</a></li><li><a href="/bigdata/zeppelin/zeppelin_sharding.html" class="sidebar-link">Zeppelin v0.8分片方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Waterdrop</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/waterdrop/waterdrop.html" class="sidebar-link">Waterdrop学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Kylin</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/kylin/awesome_kylin.html" class="sidebar-link">Kylin学习资料汇总</a></li><li><a href="/bigdata/kylin/read_kylin_source.html" class="sidebar-link">阅读Kylin源码</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Sqoop</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/sqoop/sqoop_usage.html" class="sidebar-link">代码调试</a></li><li><a href="/bigdata/sqoop/sqoop_hcatalog.html" class="sidebar-link">sqoopHCatalog使用</a></li><li><a href="/bigdata/sqoop/sqoop_mysql_temp_file.html" class="sidebar-link">sqoop导入导致MySQL产生大临时文件问题排查</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ZooKeeper</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/zookeeper/zookeeper.html" class="sidebar-link">ZooKeeper笔记</a></li><li><a href="/bigdata/zookeeper/zookeeper_user.html" class="sidebar-link">ZooKeeper管理员指南</a></li><li><a href="/bigdata/zookeeper/zk_distribute_lock.html" class="sidebar-link">zookeeper实现分布式锁</a></li><li><a href="/bigdata/zookeeper/isbn9787111524311_note.html" class="sidebar-link">《ZooKeeper分布式过程协同技术详解》笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Hadoop</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/hadoop/hadoop_interview.html" class="sidebar-link">Hadoop面试题</a></li><li><a href="/bigdata/hadoop/port.html" class="sidebar-link">Hadoop默认端口</a></li><li><a href="/bigdata/hadoop/hdfs_user.html" class="sidebar-link">HDFS命令笔记</a></li><li><a href="/bigdata/hadoop/hdfs_issue.html" class="sidebar-link">HDFS Issue</a></li><li><a href="/bigdata/hadoop/distcp.html" class="sidebar-link">Distcp命令</a></li><li><a href="/bigdata/hadoop/columnar_storage_parquet_orc.html" class="sidebar-link">列式存储（parquet,orc）</a></li><li><a href="/bigdata/hadoop/avro_specification_1.8.1.html" class="sidebar-link">avro格式规范1.8.1翻译</a></li><li><a href="/bigdata/hadoop/yarn.html" class="sidebar-link">Yarn</a></li><li><a href="/bigdata/hadoop/yarn_cli.html" class="sidebar-link">Yarn Cli命令</a></li><li><a href="/bigdata/hadoop/mapreduce.html" class="sidebar-link">MapReduce</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Hive</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/hive/hive_cli.html" class="sidebar-link">Beeline命令行</a></li><li><a href="/bigdata/hive/hive_src.html" class="sidebar-link">Hive源码分析</a></li><li><a href="/bigdata/hive/hive_ql.html" class="sidebar-link">HiveQL</a></li><li><a href="/bigdata/hive/hive_data_type.html" class="sidebar-link">Hive数据类型</a></li><li><a href="/bigdata/hive/hive_bucket.html" class="sidebar-link">Hive分桶</a></li><li><a href="/bigdata/hive/hive_principle.html" class="sidebar-link">Hive原理</a></li><li><a href="/bigdata/hive/hive_optimize.html" class="sidebar-link">Hive优化</a></li><li><a href="/bigdata/hive/hive_parse_json.html" class="sidebar-link">Hive解析json数组</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>OLAP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/olap/olap.html" class="sidebar-link">OLAP笔记</a></li><li><a href="/bigdata/olap/data_analyze.html" class="sidebar-link">数据分析笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ClickHouse</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/clickhouse/clickhouse.html" class="sidebar-link">ClickHouse学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Doris</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/doris/doris.html" class="sidebar-link">Doris笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Kudu</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/kudu/kudu.html" class="sidebar-link">Kudu</a></li><li><a href="/bigdata/kudu/kudu_paper.html" class="sidebar-link">Kudu: Storage for Fast Analytics on Fast Data</a></li><li><a href="/bigdata/kudu/kudu_paper_translation.html" class="sidebar-link">【译】Kudu论文</a></li><li><a href="/bigdata/kudu/kudu_note.html" class="sidebar-link">Kudu笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Impala</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/impala/cup.html" class="sidebar-link">CUP学习笔记</a></li><li><a href="/bigdata/impala/impala.html" class="sidebar-link">Impala</a></li><li><a href="/bigdata/impala/impala_admin.html" class="sidebar-link">Impala运维</a></li><li><a href="/bigdata/impala/impala_dev.html" aria-current="page" class="active sidebar-link">Impala开发笔记</a></li><li><a href="/bigdata/impala/impala_community.html" class="sidebar-link">Impala社区</a></li><li><a href="/bigdata/impala/impala_issues.html" class="sidebar-link">Impala问题记录</a></li><li><a href="/bigdata/impala/impala_paper_translation.html" class="sidebar-link">【转】【译】Impala：Hadoop上的一个现代开源SQL引擎</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spark</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/spark/spark.html" class="sidebar-link">Spark</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HBase</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/hbase/hbase_interview.html" class="sidebar-link">HBase</a></li><li><a href="/bigdata/hbase/hbase_user.html" class="sidebar-link">HBase使用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata/note/oss_note.html" class="sidebar-link">《快手短视频打造高稳定千亿级别对象存储平台》笔记</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="impala开发笔记"><a href="#impala开发笔记" class="header-anchor">$</a> Impala开发笔记</h1> <h2 id="编译构建"><a href="#编译构建" class="header-anchor">$</a> 编译构建</h2> <h3 id="先决条件"><a href="#先决条件" class="header-anchor">$</a> 先决条件</h3> <p>硬件要求：</p> <ul><li>CPU 必须至少支持 SSSE3</li> <li>最小内存：16GB</li> <li>硬盘空间：120GB（用于测试数据）</li></ul> <p>支持的操作系统包括：</p> <ul><li>Ubuntu 14.04, 16.04, 18.04</li> <li>CentOS 7</li></ul> <h3 id="全量构建"><a href="#全量构建" class="header-anchor">$</a> 全量构建</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># cd ~/Impala</span>
<span class="token function">bash</span> bin/bootstrap_system.sh
<span class="token builtin class-name">source</span> bin/impala-config.sh
buildall.sh <span class="token parameter variable">-release</span> <span class="token parameter variable">-notests</span>
</code></pre></div><ul><li>如果要跳过构建BE测试，将 <code>-notests</code> 传递给 buildall.sh 命令</li> <li>如果不需要完全清理，则将 <code>-noclean</code> 传递给 buildall.sh 命令</li></ul> <h4 id="参考"><a href="#参考" class="header-anchor">$</a> 参考</h4> <p><a href="https://cwiki.apache.org/confluence/display/IMPALA/Building+Impala" target="_blank" rel="noopener noreferrer">Building Impala<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="增量构建"><a href="#增量构建" class="header-anchor">$</a> 增量构建</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 重新生成cmake文件</span>
./buildall.sh <span class="token parameter variable">-cmake_only</span>

<span class="token comment"># 重新构建impalad二进制文件</span>
<span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token variable">${IMPALA_BUILD_THREADS}</span> impalad

<span class="token comment"># 重新构建java侧的fe</span>
<span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token variable">${IMPALA_BUILD_THREADS}</span> <span class="token function">java</span>

<span class="token comment"># 仅重新构建一个BE测试二进制</span>
<span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token variable">${IMPALA_BUILD_THREADS}</span> buffered-block-mgr-test
 
<span class="token comment"># 仅重新构建 FE</span>
<span class="token function">make</span> fe
</code></pre></div><p>可以使用ninja加速增量构建：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装 ninja</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ninja-build
 
<span class="token comment"># 代替命令 ./buildall.sh ...:</span>
./buildall.sh <span class="token punctuation">..</span>. <span class="token parameter variable">-ninja</span>
 
<span class="token comment"># 代替命令  make -j ${IMPALA_BUILD_THREADS} &lt;targets&gt;:</span>
ninja <span class="token parameter variable">-j</span> <span class="token variable">${IMPALA_BUILD_THREADS}</span> <span class="token operator">&lt;</span>targets<span class="token operator">&gt;</span>
 
<span class="token comment"># 使用alias以指定ninja构建线程数</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">ninja</span><span class="token operator">=</span><span class="token string">'ninja -j ${IMPALA_BUILD_THREADS}'</span>
</code></pre></div><p>使用distcc，参考：https://github.com/apache/impala/blob/4.0.0/bin/distcc/README.md</p> <p>跳过检查toolchain依赖项：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;export SKIP_TOOLCHAIN_BOOTSTRAP=true&quot;</span> <span class="token operator">&gt;&gt;</span> bin/impala-config-local.sh
</code></pre></div><h4 id="参考-2"><a href="#参考-2" class="header-anchor">$</a> 参考</h4> <p><a href="https://cwiki.apache.org/confluence/display/IMPALA/Tips+for+Faster+Impala+Builds" target="_blank" rel="noopener noreferrer">Tips for Faster Impala Builds<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="国内镜像加速"><a href="#国内镜像加速" class="header-anchor">$</a> 国内镜像加速</h3> <p>编译Impala源码的时候会下载大量的依赖包，由于大部分地址在国内的访问速度堪忧，给国内开发者增加了门槛。现提供一个非官方的镜像地址及相应配置方式，适用于Impala 4.0.0以上，仅供参考。</p> <p>注：由于服务端限制单个文件不超过 500MB，需要对某些包做裁剪（软链接重复文件），裁剪情况如下：</p> <table><thead><tr><th>版本</th> <th>c++依赖包（ToolchainPackage）</th> <th>cluster组件（CdpComponent）</th></tr></thead> <tbody><tr><td>4.0.0</td> <td>裁剪了kudu</td> <td>完整</td></tr> <tr><td>4.1.0</td> <td>裁剪了kudu</td> <td>裁剪ranger</td></tr></tbody></table> <p>编译Impala时会下载的依赖主要包括4个部分：</p> <ol><li>预置的 maven jar包</li> <li>python包</li> <li>maven jar 包</li> <li>toolchain包</li></ol> <p>其中：</p> <p>第 1 部分不是必须的，4.2.0以下可以在bootstrap_system.sh脚本中注释掉，参考：<a href="http://issues.apache.org/jira/browse/IMPALA-11439" target="_blank" rel="noopener noreferrer">IMPALA-11439<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。4.2.0以上在初始化的时候通过环境变量跳过：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 不下载预置maven包</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">PREPOPULATE_M2_REPOSITORY</span><span class="token operator">=</span>false
<span class="token comment"># 初始化编译环境</span>
<span class="token variable">${IMPALA_HOME}</span>/bin/bootstrap_system.sh
</code></pre></div><p>第 2 部分可以通过配置PYPI的国内镜像地址（4.1.0以下需要打个 patch：<a href="http://issues.apache.org/jira/browse/IMPALA-10994" target="_blank" rel="noopener noreferrer">IMPALA-10994<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）来加速，如：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">PYPI_MIRROR</span><span class="token operator">=</span>https://pypi.tuna.tsinghua.edu.cn
</code></pre></div><p>通过下面命令单独下载python包：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token variable">${IMPALA_HOME}</span>/infra/python/deps/download_requirements
</code></pre></div><p>第 3 部分：配置~/.m2/settings.xml如下（变量repoId，username，password请在“图解代码”公众号发送关键字“Impala镜像”获取）：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span> <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/SETTINGS/1.0.0<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servers</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>rdc-releases<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span>${username}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>${password}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servers</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirrors</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirror</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>aliyunmaven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>central<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://maven.aliyun.com/repository/public<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirror</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirror</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>rdc-releases<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>*,!central<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://packages.aliyun.com/maven/repository/${repoId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirror</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirrors</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>settings</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>之后再运行 mvn 命令的时候就能使用镜像地址进行加速了。</p> <p>第 4 部分：写入~/.netrc文件（变量username，password的获取参考第 3 部分）：</p> <div class="language- extra-class"><pre class="language-text"><code>machine packages.aliyun.com login ${username} password ${password}
</code></pre></div><p>运行以下命令下载 toolchain（变量repoId的获取参考第 3 部分）：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 禁止重复下载python包</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SKIP_PYTHON_DOWNLOAD</span><span class="token operator">=</span>true
<span class="token comment"># 下载minicluster依赖的组件</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">DOWNLOAD_CDH_COMPONENTS</span><span class="token operator">=</span>true
<span class="token comment"># 下载c++的依赖包</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SKIP_TOOLCHAIN_BOOTSTRAP</span><span class="token operator">=</span>false

<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMPALA_TOOLCHAIN_HOST</span><span class="token operator">=</span>packages.aliyun.com/maven/repository/<span class="token variable">${repoId}</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMPALA_HADOOP_URL</span><span class="token operator">=</span><span class="token string">'https://${toolchain_host}/build/hadoop/${version}/hadoop-${version}.tar.gz'</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMPALA_HBASE_URL</span><span class="token operator">=</span><span class="token string">'https://${toolchain_host}/build/hbase/${version}/hbase-${version}-bin.tar.gz'</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMPALA_HIVE_URL</span><span class="token operator">=</span><span class="token string">'https://${toolchain_host}/build/apache-hive/${version}/apache-hive-${version}-bin.tar.gz'</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMPALA_HIVE_SOURCE_URL</span><span class="token operator">=</span><span class="token string">'https://${toolchain_host}/build/hive/${version}/hive-${version}-source.tar.gz'</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMPALA_RANGER_URL</span><span class="token operator">=</span><span class="token string">'https://${toolchain_host}/build/ranger/${version}/ranger-${version}-admin.tar.gz'</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMPALA_TEZ_URL</span><span class="token operator">=</span><span class="token string">'https://${toolchain_host}/build/tez/${version}/tez-${version}-minimal.tar.gz'</span>

<span class="token comment"># 执行下载动作</span>
<span class="token variable">${IMPALA_HOME}</span>/bin/bootstrap_toolchain.py
</code></pre></div><h3 id="buildall-sh详细用法"><a href="#buildall-sh详细用法" class="header-anchor">$</a> buildall.sh详细用法</h3> <p>主要作用是编译代码，启动impala依赖的minicluster集群（包括HDFS，Hive，HBase，Kudu等），启动Impala集群（包括catalogd, statestored, impalad），加载测试元数据及数据，执行测试。</p> <p>参数说明：</p> <table><thead><tr><th>参数</th> <th>内部变量</th> <th>默认值</th> <th>说明</th></tr></thead> <tbody><tr><td>-noclean</td> <td>CLEAN_ACTION</td> <td>False</td> <td>不清理编译输出目录。</td></tr> <tr><td>-format</td> <td>FORMAT_CLUSTER, <br>FORMAT_METASTORE,<br>FORMAT_RANGER_POLICY_DB</td> <td>False</td> <td>格式化 minicluster, metastore db, 和 ranger policy db</td></tr> <tr><td>-format_cluster</td> <td>FORMAT_CLUSTER</td> <td>False</td> <td>格式化 minicluster</td></tr> <tr><td>-format_metastore</td> <td>FORMAT_METASTORE</td> <td>False</td> <td>格式化 metastore db</td></tr> <tr><td>-format_ranger_policy_db</td> <td>FORMAT_RANGER_POLICY_DB</td> <td>False</td> <td>格式化 Ranger policy db</td></tr> <tr><td>-upgrade_metastore_db</td> <td>UPGRADE_METASTORE_SCHEMA</td> <td>False</td> <td>升级metastore db的schema</td></tr> <tr><td>-release_and_debug</td> <td>BUILD_RELEASE_AND_DEBUG</td> <td>false</td> <td>同时构建 release 和 debug 二进制文件. 覆盖其他的构建类型</td></tr> <tr><td>-release</td> <td>CMAKE_BUILD_TYPE</td> <td>debug</td> <td>构建Release</td></tr> <tr><td>-codecoverage</td> <td>CODE_COVERAGE</td> <td>False</td> <td>Build with code coverage</td></tr> <tr><td>-asan</td> <td>BUILD_ASAN</td> <td>False</td> <td>构建Address sanitizer</td></tr> <tr><td>-tidy</td> <td>BUILD_TIDY</td> <td>False</td> <td>构建clang-tidy</td></tr> <tr><td>-tsan</td> <td>BUILD_TSAN</td> <td>False</td> <td>构建Thread sanitizer, 和参数 ignore_noninstrumented_modules=1一起运行. 当此flag是 true, TSAN 忽略从 non-instrumented libraries的内存访问. 这降低了假阳性数量, 但会漏掉真正的问题. -full_tsan参数会禁用此 flag</td></tr> <tr><td>-full_tsan</td> <td>BUILD_TSAN_FULL</td> <td>False</td> <td>构建Thread sanitizer, 和参数 ignore_noninstrumented_modules=0 一起运行(看-tsan 的描述阐述了这个flag做了什么)</td></tr> <tr><td>-ubsan</td> <td>BUILD_UBSAN</td> <td>False</td> <td>构建Undefined behavior sanitizer</td></tr> <tr><td>-full_ubsan</td> <td>BUILD_UBSAN_FULL</td> <td>False</td> <td>构建Undefined behavior sanitizer, 包交叉编译生成的 LLVM IR代码. 比单纯的-ubsan查询更慢</td></tr> <tr><td>-skiptests</td> <td>TESTS_ACTION</td> <td>False</td> <td>跳过执行所有的测试</td></tr> <tr><td>-notests</td> <td>BUILD_TESTS, TESTS_ACTION</td> <td>False</td> <td>跳过构建和执行所有的测试</td></tr> <tr><td>-start_minicluster</td> <td>NEED_MINICLUSTER</td> <td>如果运行测试或加载数据为True，否则为False</td> <td>启动测试集群，包括Impala和它依赖的集群。如果已经在运行，所有服务都会重启，重新生成 test cluster 配置文件</td></tr> <tr><td>-start_impala_cluster</td> <td>START_IMPALA_CLUSTER</td> <td>False</td> <td>在构建完成后启动 Impala minicluster</td></tr> <tr><td>-testpairwise</td> <td>EXPLORATION_STRATEGY</td> <td>ore</td> <td>以'pairwise' 模式运行测试 (会增加测试执行时间)</td></tr> <tr><td>-testexhaustive</td> <td>EXPLORATION_STRATEGY</td> <td>core</td> <td>以 'exhaustive' 模式运行测试, 会显著增加测试执行时间.仅应用于workload套件：functional-query, targeted-stress</td></tr> <tr><td>-testdata</td> <td>TESTDATA_ACTION</td> <td>False</td> <td>加载测试数据. 如果指定了-snapshot_file 默认为True. 如果-snapshot_file没有指定, 数据会被重新生成。</td></tr> <tr><td>-snapshot_file &lt;file name&gt;</td> <td>SNAPSHOT_FILE</td> <td>-</td> <td>从一个snapshot file加载测试数据</td></tr> <tr><td>-metastore_snapshot_file &lt;file_name&gt;: Load the hive metastore snapshot</td> <td>METASTORE_SNAPSHOT_FILE</td> <td>-</td> <td>加载Hive metastore 快照</td></tr> <tr><td>-so|-build_shared_libs</td> <td>BUILD_SHARED_LIBS</td> <td>static</td> <td>动态连接可执行文件</td></tr> <tr><td>-fe_only</td> <td>BUILD_FE_ONLY</td> <td>0</td> <td>仅构建fe</td></tr> <tr><td>-ninja</td> <td>MAKE_CMD</td> <td></td> <td>使用 ninja 替代 make</td></tr> <tr><td>-cmake_only</td> <td>GEN_CMAKE_ONLY</td> <td>0</td> <td>仅生成 makefiles, 而不是执行全量构建</td></tr> <tr><td>-v|-debug</td> <td>-</td> <td>-</td> <td>使用调试模式执行shell脚本</td></tr></tbody></table> <p>外部环境变量：</p> <table><thead><tr><th>变量名</th> <th>候选值</th> <th>默认值</th> <th>说明</th></tr></thead> <tbody><tr><td>CMAKE_BUILD_TYPE</td> <td>Debug, Release</td> <td>Debug</td> <td>编译Debug版还是Release版，可以通过命令行参数<code>-release</code>覆盖</td></tr> <tr><td>DOWNLOAD_CDH_COMPONENTS</td> <td>true,false</td> <td>无</td> <td>控制是否下载toolchain的开关之一</td></tr> <tr><td>EXPLORATION_STRATEGY</td> <td>core, pairwise, exhaustive</td> <td>core</td> <td>运行测试的模式，可以通过命令行参数<code>-testpairwise</code> 或 <code>testexhaustive</code>覆盖</td></tr> <tr><td>IMPALA_ALL_LOGS_DIRS</td> <td>任意</td> <td>无</td> <td>impala所有日志根目录</td></tr> <tr><td>IMPALA_BUILD_THREADS</td> <td>任意</td> <td>4</td> <td>编译线程数</td></tr> <tr><td>IMPALA_HOME</td> <td>任意</td> <td>无</td> <td>impala源码目录</td></tr> <tr><td>IMPALA_MAKE_FLAGS</td> <td>任意</td> <td>无</td> <td>make命令flags</td></tr> <tr><td>SKIP_PYTHON_DOWNLOAD</td> <td>true, false</td> <td>无</td> <td>不下载python依赖库</td></tr> <tr><td>SKIP_TOOLCHAIN_BOOTSTRAP</td> <td>true, false</td> <td>无</td> <td>控制是否下载toolchain的开关之一</td></tr> <tr><td>TARGET_FILESYSTEM</td> <td>hdfs,s3,local</td> <td>dfs</td> <td>加载测试数据的文件系统</td></tr> <tr><td>CDP_FILE</td> <td>-</td> <td>${IMPALA_HOME}/.cdp</td> <td>内容为$CDP_BUILD_NUMBER</td></tr></tbody></table> <p>常见用例：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 构建并运行所有测试</span>
./buildall.sh

<span class="token comment"># 构建并跳过测试</span>
./buildall.sh <span class="token parameter variable">-skiptests</span>

<span class="token comment"># 构建,然后刷新配置重启minicluster和Impala</span>
./buildall.sh <span class="token parameter variable">-notests</span> <span class="token parameter variable">-start_minicluster</span> <span class="token parameter variable">-start_impala_cluster</span>

<span class="token comment"># 增量构建并跳过测试.保持现有的minicluster服务运行并重启Impala</span>
./buildall.sh <span class="token parameter variable">-skiptests</span> <span class="token parameter variable">-noclean</span> <span class="token parameter variable">-start_impala_cluster</span>

<span class="token comment"># 构建,加载一个snapshot文件, 运行测试</span>
./buildall.sh <span class="token parameter variable">-snapshot_file</span> <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span>

<span class="token comment"># 构建,加载hive metastore和hdfs snapshot, 运行测试</span>
./buildall.sh <span class="token parameter variable">-snapshot_file</span> <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span> <span class="token parameter variable">-metastore_snapshot_file</span> <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span>

<span class="token comment"># 构建,生成,和增量加载测试数据，并且不格式化mini-cluster (重用HDFS上已存在的数据). 比从snapshot加载更快</span>
./buildall.sh <span class="token parameter variable">-testdata</span>

<span class="token comment"># 构建, 格式化mini-cluster和metastore,加载所有测试数据,运行测试</span>
./buildall.sh <span class="token parameter variable">-testdata</span> <span class="token parameter variable">-format</span>

<span class="token comment"># 构建并升级metastore schema至最新版.</span>
./buildall.sh <span class="token parameter variable">-upgrade_metastore_db</span>
</code></pre></div><h3 id="组件默认端口"><a href="#组件默认端口" class="header-anchor">$</a> 组件默认端口</h3> <table><thead><tr><th>组件</th> <th>端口</th> <th>描述</th></tr></thead> <tbody><tr><td>KMS</td> <td>9600</td> <td>Web UI 端口</td></tr> <tr><td>NameNode</td> <td>5070</td> <td>Web UI 端口</td></tr> <tr><td>NameNode</td> <td>20500</td> <td>服务端口</td></tr> <tr><td>ResourceManager</td> <td>8088</td> <td>Web UI 端口</td></tr> <tr><td>PostgreSQL</td> <td>5432</td> <td>服务端口</td></tr> <tr><td>HiveServer2</td> <td>10001</td> <td>HTTP JDBC 端口</td></tr> <tr><td>HiveServer2</td> <td>10002</td> <td></td></tr> <tr><td>HiveServer2</td> <td>11050</td> <td>JDBC端口</td></tr> <tr><td>HiveServer2</td> <td>30020</td> <td>JVM调试端口</td></tr> <tr><td>HiveMetaStore</td> <td>9083</td> <td>服务端口</td></tr> <tr><td>HiveMetaStore</td> <td>30010</td> <td>JVM调试端口</td></tr> <tr><td>Ranger</td> <td>6080</td> <td>Web UI 端口</td></tr> <tr><td>Ranger</td> <td>6085</td> <td></td></tr> <tr><td>Ranger</td> <td>30130</td> <td>JVM调试端口</td></tr> <tr><td>HRegionServer</td> <td>16030,16032,16033</td> <td>Web UI 端口</td></tr> <tr><td>ZooKeeper</td> <td>2181</td> <td>服务端口</td></tr> <tr><td>ZooKeeper</td> <td>8080</td> <td></td></tr> <tr><td>kudu master</td> <td>7051</td> <td>服务端口</td></tr> <tr><td>kudu master</td> <td>8051</td> <td>Web UI 端口</td></tr></tbody></table> <h4 id="参考-3"><a href="#参考-3" class="header-anchor">$</a> 参考</h4> <p><a href="https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.0/administration/content/ranger-ports.html" target="_blank" rel="noopener noreferrer">Ranger service ports<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="编译时间优化"><a href="#编译时间优化" class="header-anchor">$</a> 编译时间优化</h3> <h4 id="编译展开分析"><a href="#编译展开分析" class="header-anchor">$</a> 编译展开分析</h4> <p>在cmake中指定编译选型&quot;-save-temps&quot;保留编译中间文件：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment"># be/CMakeLists.txt</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_FLAGS</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CXX_FLAGS</span><span class="token punctuation">}</span></span> -save-temps&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="头文件依赖分析"><a href="#头文件依赖分析" class="header-anchor">$</a> 头文件依赖分析</h4> <p>通过工具统计出编译源文件直接和间接依赖的头文件的总个数。</p> <h4 id="编译耗时统计"><a href="#编译耗时统计" class="header-anchor">$</a> 编译耗时统计</h4> <p>从结果上看各个文件的编译耗时以及各个编译阶段的耗时情况，正常情况下，是和文件展开大小以及头文件引用个数是正相关的。</p> <p>cmake通过指定环境变量能打印出编译和链接阶段的耗时情况：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment"># export IMPALA_BUILD_THREADS=1</span>
<span class="token comment"># be/CMakeLists.txt</span>
<span class="token keyword">set_property</span><span class="token punctuation">(</span>GLOBAL PROPERTY <span class="token property">RULE_LAUNCH_COMPILE</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_COMMAND</span><span class="token punctuation">}</span></span> -E time&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set_property</span><span class="token punctuation">(</span>GLOBAL PROPERTY <span class="token property">RULE_LAUNCH_LINK</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_COMMAND</span><span class="token punctuation">}</span></span> -E time&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="参考-4"><a href="#参考-4" class="header-anchor">$</a> 参考</h4> <p><a href="https://tech.meituan.com/2020/12/10/apache-kylin-practice-in-meituan.html" target="_blank" rel="noopener noreferrer">C++服务编译耗时优化原理及实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="代码调试"><a href="#代码调试" class="header-anchor">$</a> 代码调试</h2> <h3 id="参考-5"><a href="#参考-5" class="header-anchor">$</a> 参考</h3> <p><a href="https://cwiki.apache.org/confluence/display/IMPALA/Impala+Debugging+Tips" target="_blank" rel="noopener noreferrer">Impala Debugging Tips<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="源码分析"><a href="#源码分析" class="header-anchor">$</a> 源码分析</h2> <p>以下代码以<a href="https://github.com/apache/impala/blob/4.0.0" target="_blank" rel="noopener noreferrer">4.0.0源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>为例。</p> <h3 id="术语表"><a href="#术语表" class="header-anchor">$</a> 术语表</h3> <table><thead><tr><th>术语</th> <th>说明</th></tr></thead> <tbody><tr><td>lhs, rhs</td> <td>Left-side-hand, right-side-hand缩写</td></tr> <tr><td>c'tor</td> <td>constructor缩写</td></tr> <tr><td>localViews_</td> <td>a view definition in this analyzer's scope</td></tr> <tr><td></td> <td></td></tr> <tr><td></td> <td></td></tr> <tr><td></td> <td></td></tr> <tr><td></td> <td></td></tr></tbody></table> <h3 id="bootstrap-system-sh"><a href="#bootstrap-system-sh" class="header-anchor">$</a> bootstrap_system.sh</h3> <p>为开发环境做些准备，大体执行流程：</p> <ul><li>设置环境变量 IMPALA_HOME</li> <li>如果是交互模式，询问是否愿意更改环境配置，是则继续，否则退出；如果不是交互模式，直接执行。</li> <li>判断Linux发行版版本（REDHAT6，REDHAT7，UBUNTU16.04），以及是否在Docker内</li> <li>安装一堆软件包，包括编译相关工具，kerberos，postgresql等</li> <li>下载apache-ant-1.9.14和apache-maven-3.5.4并安装到目录<code>/usr/local</code>下</li> <li>启动ssh服务</li> <li>初始化postgresql并启动</li> <li>为HMS创建账号，用户名：hiveuser，密码：password</li> <li>配置到localhost的免密登录</li> <li>配置<code>/etc/hosts</code></li> <li>创建目录：<code>/var/lib/hadoop-hdfs</code></li> <li>配置系统最大打开文件数为1048576，最大进程数为unlimited</li> <li>如果IMPALA_HOME目录不存在，则checkout Impala源码，并导出环境变量 IMPALA_HOME到<code>~/.bashrc</code></li> <li>配置JAVA_HOME，并固化到<code>bin/impala-config-local.sh</code></li> <li>下载maven软件包到本地仓库</li></ul> <p>在Docker里运行此脚本需要做的准备：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 添加参数--privileged</span>
<span class="token function">docker</span> run <span class="token parameter variable">--privileged</span> --cap-add SYS_TIME <span class="token parameter variable">-d</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span> impala_build ubuntu:16.04 <span class="token function">bash</span>
<span class="token comment"># 赋予容器一个非root无需密码的sudoer：</span>
<span class="token function">apt-get</span> update
<span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">sudo</span>
adduser --disabled-password <span class="token parameter variable">--gecos</span> <span class="token string">''</span> impdev
<span class="token builtin class-name">echo</span> <span class="token string">'impdev ALL=(ALL) NOPASSWD:ALL'</span> <span class="token operator">&gt;&gt;</span> /etc/sudoers

<span class="token comment"># 使用新建的用户运行：</span>
<span class="token function">su</span> - impdev <span class="token parameter variable">-c</span> bin/bootstrap_development.sh
</code></pre></div><h3 id="buildall-sh"><a href="#buildall-sh" class="header-anchor">$</a> buildall.sh</h3> <p>编译前的准备步骤包括：</p> <ul><li><p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L55,L85" target="_blank" rel="noopener noreferrer">第55行至85行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 设置内部变量的默认值。</p></li> <li><p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L88,L286" target="_blank" rel="noopener noreferrer">第88行至286行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>解析命令行参数并设置内部变量。</p></li> <li><p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L344,L349" target="_blank" rel="noopener noreferrer">第344行至349行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>校验启用kerberos的集群上不支持运行测试或者加载测试数据。</p></li> <li><p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L351,L356" target="_blank" rel="noopener noreferrer">第351行至356行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>校验加载测试数据的hive元数据快照仅支持hdfs文件系统。</p></li> <li><p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L575" target="_blank" rel="noopener noreferrer">第575行至578行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>调用脚本<code>bin/clean.sh</code>清理之前的构建目录。</p></li> <li><p>在函数<a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L365,L380" target="_blank" rel="noopener noreferrer"><code>create_log_dirs()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中创建统一的日志目录。</p></li> <li><p>在函数<a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L382,L422" target="_blank" rel="noopener noreferrer"><code>bootstrap_dependencies()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，中下载python依赖和toolchain：</p> <ul><li>如果<code>SKIP_PYTHON_DOWNLOAD=false</code>则执行脚本<code>infra/python/deps/download_requirements</code>下载python的依赖。</li> <li>如果<code>SKIP_TOOLCHAIN_BOOTSTRAP=true</code>且<code>DOWNLOAD_CDH_COMPONENTS=true</code>，或者<code>SKIP_TOOLCHAIN_BOOTSTRAP=false</code>，则执行脚本<code>bin/bootstrap_toolchain.py</code>下载toolchain。</li></ul></li></ul> <p>编译过程首先调用cmake命令生成Makefile，即函数<a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L460,L501" target="_blank" rel="noopener noreferrer"><code>generate_cmake_files()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，cmake的参数包括：<code>-DCMAKE_BUILD_TYPE</code>，<code>-DBUILD_SHARED_LIBS</code>，<code>-GNinja</code>，<code>-DCMAKE_TOOLCHAIN_FILE</code>，<code>-DCACHELINESIZE_AARCH64</code> 。不同构建需求的区别主要在于参数<code>CMAKE_BUILD_TYPE</code>的不同，它的默认值是<code>Debug</code>，除了默认值之外还有9种互斥的情况：</p> <ul><li><code>CODE_COVERAGE_DEBUG</code>，由参数<code>-codecoverage</code>和<code>-release</code>确定。</li> <li><code>CODE_COVERAGE_RELEASE</code>，由参数<code>-codecoverage</code>和<code>-release</code>确定。</li> <li><code>RELEASE</code>，由参数<code>-release</code>确定。</li> <li><code>ADDRESS_SANITIZER</code>，由参数<code>-asan</code>确定。</li> <li><code>TIDY</code>，由参数<code>-tidy</code>确定。</li> <li><code>UBSAN</code>，由参数<code>-ubsan</code>确定。</li> <li><code>UBSAN_FULL</code>，由参数<code>-full_ubsan</code>确定。</li> <li><code>TSAN</code>，由参数<code>-tsan</code>确定。</li> <li><code>TSAN_FULL</code>，由参数<code>-full_tsan</code>确定。</li></ul> <p>如果指定了参数<code>-cmake_only</code>则仅会根据参数<code>CMAKE_BUILD_TYPE</code>生成Makefile。</p> <p>如果指定了参数<code>-fe_only</code>则在生成Makefile之后仅编译<code>FE</code>部分。</p> <p>如果以上两个参数都没有指定，则会调用函数<a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L435,L455" target="_blank" rel="noopener noreferrer"><code>build_all_components()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>构建所有组件（包括FE和BE等）。</p> <ul><li><p>如果指定了参数<code>-release_and_debug</code>，则会依次生成RELEASE和DEBUG类型的Makefile；否则根据参数确定的<code>CMAKE_BUILD_TYPE</code>来生成Makefile。</p></li> <li><p>然后调用<code>make</code>命令执行编译过程，make命令的目标有三种情况：</p></li></ul> <table><thead><tr><th>编译测试文件</th> <th>是否编译不相关目标</th> <th>MAKE目标</th></tr></thead> <tbody><tr><td>False</td> <td>True</td> <td>notests_all_targets</td></tr> <tr><td>False</td> <td>False</td> <td>notests_regular_targets</td></tr> <tr><td>True</td> <td>任意</td> <td>（空）</td></tr></tbody></table> <p>接下来是minicluster相关，<a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L506,L534" target="_blank" rel="noopener noreferrer">第506行至534行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>定义了函数<code>reconfigure_test_cluster()</code>，主要作用是调用<code>bin/create-test-configuration.sh</code>脚本生成impala依赖的hadoop配置文件，同时还会执行格式化元数据相关操作（会先kill掉minicluster集群）：</p> <ul><li><p><code>-format_cluster</code>的操作最终是删除了hdfs和kudu的数据目录：</p> <p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L542" target="_blank" rel="noopener noreferrer">buildall.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> =&gt; <a href="https://github.com/apache/impala/blob/4.0.0/testdata/bin/run-all.sh#L54" target="_blank" rel="noopener noreferrer">testdata/bin/run-all.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> =&gt; <a href="https://github.com/apache/impala/blob/4.0.0/testdata/bin/run-mini-dfs.sh#L38" target="_blank" rel="noopener noreferrer">testdata/bin/run-mini-dfs.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> =&gt; <a href="https://github.com/apache/impala/blob/4.0.0/testdata/cluster/admin#L459,L463" target="_blank" rel="noopener noreferrer">testdata/cluster/admin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><code>-format_metastore</code>操作最终在pg数据库里删除重建了metastore的db，并执行<code>schematool -initSchema</code>命令：</p> <p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L533" target="_blank" rel="noopener noreferrer">buildall.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> =&gt; <a href="https://github.com/apache/impala/blob/4.0.0/bin/create-test-configuration.sh#L162,L165" target="_blank" rel="noopener noreferrer">bin/create-test-configuration.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><code>-format_ranger_policy_db</code>的操作同样删除重建了Ranger Policy的db，并在<code>RANGER_HOME</code>目录下生成<code>install.properties</code>配置文件，并执行<code>db_setup.py</code>：</p> <p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L533" target="_blank" rel="noopener noreferrer">buildall.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> =&gt; <a href="https://github.com/apache/impala/blob/4.0.0/bin/create-test-configuration.sh#L185,L193" target="_blank" rel="noopener noreferrer">bin/create-test-configuration.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><code>-upgrade_metastore_db</code>最终是执行<code>schematool -upgradeSchema</code>命令：</p> <p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L533" target="_blank" rel="noopener noreferrer">buildall.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> =&gt; <a href="https://github.com/apache/impala/blob/4.0.0/bin/create-test-configuration.sh#L181" target="_blank" rel="noopener noreferrer">bin/create-test-configuration.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <p>如果指定了参数<code>-metastore_snapshot_file</code>，则调用脚本<a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L620,L623" target="_blank" rel="noopener noreferrer"><code>testdata/bin/load-metastore-snapshot.sh</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>加载Hive metastore的元数据。</p> <p><a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L537,L543" target="_blank" rel="noopener noreferrer">第537行至543行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>定义了函数<code>start_test_cluster_dependencies()</code>，主要是调用脚本<code>testdata/bin/run-all.sh</code>启动minicluster集群。</p> <p>在minicluster集群启动之后，<a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L548,L565" target="_blank" rel="noopener noreferrer">第548行至565行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>定义了函数<code>load_test_data()</code>，用来执行数据加载步骤：</p> <ul><li><p>执行脚本<code>$IMPALA_HOME/bin/create_testdata.sh</code></p></li> <li><p>执行脚本<code>${IMPALA_HOME}/testdata/bin/create-load-data.sh</code>。根据变量<code>SNAPSHOT_FILE</code> 和变量<code>METASTORE_SNAPSHOT_FILE</code>的值是否为空，传递的参数有4种组合情况：</p> <table><thead><tr><th>SNAPSHOT_FILE</th> <th>METASTORE_SNAPSHOT_FILE</th> <th>CREATE_LOAD_DATA_ARGS</th></tr></thead> <tbody><tr><td>不为空</td> <td>不为空</td> <td>-snapshot_file, -skip_metadata_load</td></tr> <tr><td>不为空</td> <td>空</td> <td>-snapshot_file</td></tr> <tr><td>空</td> <td>不为空</td> <td>-skip_metadata_load -skip_snapshot_load</td></tr> <tr><td>空</td> <td>空</td> <td>空</td></tr></tbody></table></li></ul> <p>在数据加载完成之后，<a href="https://github.com/apache/impala/blob/4.0.0/buildall.sh#L567,L573" target="_blank" rel="noopener noreferrer">第567行至573行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>定义了函数<code>run_all_tests()</code>，调用脚本<code>bin/run-all-tests.sh</code>运行测试。</p> <h3 id="report-build-error-sh"><a href="#report-build-error-sh" class="header-anchor">$</a> report_build_error.sh</h3> <p>setup_report_build_error函数功能：如果接收到错误，打印行号。</p> <h3 id="clean-sh"><a href="#clean-sh" class="header-anchor">$</a> clean.sh</h3> <p>清理编译输出目录，包括：</p> <ul><li>扩展数据源输出目录</li> <li>fe输出目录</li> <li>be输出目录</li> <li>shell输出目录</li> <li>python中间文件和目录</li> <li>llvm输出目录</li> <li>cmake生成文件</li></ul> <h3 id="download-requirements"><a href="#download-requirements" class="header-anchor">$</a> download_requirements</h3> <p>替代pip命令从PyPI源下载python包，可以通过环境变量<code>PYPI_MIRROR</code>设置PyPI源镜像地址，下载的python包列表在<code>infra/python/deps/requirements.txt</code>等文件中指定。</p> <p>至于为什么不用pip命令下载，注释说的意思是不同操作系统下载不稳定和不一致（Impala也只支持Linux啊，感觉站不住脚），还有避免执行可能会失败的某些包的setup.py，参考：<a href="http://issues.apache.org/jira/browse/IMPALA-3778" target="_blank" rel="noopener noreferrer">IMPALA-3778<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="bootstrap-toolchain-py"><a href="#bootstrap-toolchain-py" class="header-anchor">$</a> bootstrap_toolchain.py</h3> <h3 id="create-test-configuration-sh"><a href="#create-test-configuration-sh" class="header-anchor">$</a> create-test-configuration.sh</h3> <p>使用说明：</p> <div class="language- extra-class"><pre class="language-text"><code>[-create_metastore] : If true, creates a new metastore.
[-create_ranger_policy_db] : If true, creates a new Ranger policy db.
[-upgrade_metastore_db] : If true, upgrades the schema of HMS db.
</code></pre></div><h3 id="load-metastore-snapshot-sh"><a href="#load-metastore-snapshot-sh" class="header-anchor">$</a> load-metastore-snapshot.sh</h3> <h3 id="create-testdata-sh"><a href="#create-testdata-sh" class="header-anchor">$</a> create_testdata.sh</h3> <h3 id="create-load-data-sh"><a href="#create-load-data-sh" class="header-anchor">$</a> create-load-data.sh</h3> <h3 id="run-all-sh"><a href="#run-all-sh" class="header-anchor">$</a> run-all.sh</h3> <h3 id="run-mini-dfs-sh"><a href="#run-mini-dfs-sh" class="header-anchor">$</a> run-mini-dfs.sh</h3> <h3 id="run-all-tests-sh"><a href="#run-all-tests-sh" class="header-anchor">$</a> run-all-tests.sh</h3> <h3 id="frontend"><a href="#frontend" class="header-anchor">$</a> Frontend</h3> <p>impalad服务端接收请求入口：<code>impala-beeswax-server.cc#ImpalaServer::query()</code></p> <p>Frontend.cc#Frontend::GetExecRequest() 通过JNI接口调用</p> <p>org.apache.impala.planner.Planner.createPlan()</p> <h4 id="org-apache-impala-planner-plannode"><a href="#org-apache-impala-planner-plannode" class="header-anchor">$</a> org.apache.impala.planner.PlanNode</h4> <p>slot, materialized, conjuncts,</p> <h4 id="org-apache-impala-planner-plannodeid"><a href="#org-apache-impala-planner-plannodeid" class="header-anchor">$</a> org.apache.impala.planner.PlanNodeId</h4> <h4 id="org-apache-impala-analysis-tupledescriptor"><a href="#org-apache-impala-analysis-tupledescriptor" class="header-anchor">$</a> org.apache.impala.analysis.TupleDescriptor</h4> <h4 id="org-apache-impala-catalog-feview"><a href="#org-apache-impala-catalog-feview" class="header-anchor">$</a> org.apache.impala.catalog.FeView</h4> <p>LocalView</p> <p>=======</p> <h4 id="类型系统"><a href="#类型系统" class="header-anchor">$</a> 类型系统</h4> <h5 id="org-apache-impala-catalog-primitivetype"><a href="#org-apache-impala-catalog-primitivetype" class="header-anchor">$</a> org.apache.impala.catalog.PrimitiveType</h5> <p>为什么有了对应的thrift类还要有PrimitiveType？</p> <p>org.apache.impala.catalog.Type</p> <p>org.apache.impala.catalog.ScalarType</p> <h4 id="sql解析"><a href="#sql解析" class="header-anchor">$</a> SQL解析</h4> <h5 id="org-apache-impala-analysis-statementbase"><a href="#org-apache-impala-analysis-statementbase" class="header-anchor">$</a> org.apache.impala.analysis.StatementBase</h5> <p>子类：</p> <table><thead><tr><th>类名</th> <th>抽象类</th> <th>说明</th></tr></thead> <tbody><tr><td>QueryStmt</td> <td>T</td> <td></td></tr> <tr><td>ModifyStmt</td> <td>T</td> <td></td></tr> <tr><td>AlterDbStmt</td> <td>T</td> <td></td></tr> <tr><td>AlterTableStmt</td> <td>T</td> <td></td></tr> <tr><td>AlterTableSetColumnStats</td> <td>T</td> <td></td></tr> <tr><td>AlterTableOrViewSetOwnerStmt</td> <td>T</td> <td></td></tr> <tr><td>CommentOnStmt</td> <td>T</td> <td></td></tr> <tr><td>CommentOnTableOrViewStmt</td> <td>T</td> <td></td></tr> <tr><td>CreateFunctionStmtBase</td> <td>T</td> <td></td></tr> <tr><td>CreateOrAlterViewStmtBase</td> <td>T</td> <td></td></tr> <tr><td>AdminFnStmt</td> <td></td> <td></td></tr> <tr><td>AlterDbSetOwnerStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableAddColsStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableAddDropRangePartitionStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableAddPartitionStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableAlterColStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableDropColStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableDropPartitionStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableOrViewRenameStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableRecoverPartitionsStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableReplaceColsStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableSetCachedStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableSetFileFormatStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableSetLocationStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableSetOwnerStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableSetRowFormatStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableSetStmt</td> <td></td> <td></td></tr> <tr><td>AlterTableSetTblProperties</td> <td></td> <td></td></tr> <tr><td>AlterTableSortByStmt</td> <td></td> <td></td></tr> <tr><td>AlterViewSetOwnerStmt</td> <td></td> <td></td></tr> <tr><td>AlterViewStmt</td> <td></td> <td></td></tr> <tr><td>AuthorizationStmt</td> <td></td> <td></td></tr> <tr><td>CommentOnColumnStmt</td> <td></td> <td></td></tr> <tr><td>CommentOnDbStmt</td> <td></td> <td></td></tr> <tr><td>CommentOnTableStmt</td> <td></td> <td></td></tr> <tr><td>CommentOnViewStmt</td> <td></td> <td></td></tr> <tr><td>ComputeStatsStmt</td> <td></td> <td></td></tr> <tr><td>CopyTestCaseStmt</td> <td></td> <td></td></tr> <tr><td>CreateDataSrcStmt</td> <td></td> <td></td></tr> <tr><td>CreateDbStmt</td> <td></td> <td></td></tr> <tr><td>CreateDropRoleStmt</td> <td></td> <td></td></tr> <tr><td>CreateTableAsSelectStmt</td> <td></td> <td></td></tr> <tr><td>CreateTableDataSrcStmt</td> <td></td> <td></td></tr> <tr><td>CreateTableLikeFileStmt</td> <td></td> <td></td></tr> <tr><td>CreateTableLikeStmt</td> <td></td> <td></td></tr> <tr><td>CreateTableStmt</td> <td></td> <td></td></tr> <tr><td>CreateUdaStmt</td> <td></td> <td></td></tr> <tr><td>CreateUdfStmt</td> <td></td> <td></td></tr> <tr><td>CreateUdtStmt</td> <td></td> <td></td></tr> <tr><td>CreateViewStmt</td> <td></td> <td></td></tr> <tr><td>DeleteStmt</td> <td></td> <td></td></tr> <tr><td>DescribeDbStmt</td> <td></td> <td></td></tr> <tr><td>DescribeTableStmt</td> <td></td> <td></td></tr> <tr><td>DropDataSrcStmt</td> <td></td> <td></td></tr> <tr><td>DropDbStmt</td> <td></td> <td></td></tr> <tr><td>DropFunctionStmt</td> <td></td> <td></td></tr> <tr><td>DropStatsStmt</td> <td></td> <td></td></tr> <tr><td>DropTableOrViewStmt</td> <td></td> <td></td></tr> <tr><td>GrantRevokePrivStmt</td> <td></td> <td></td></tr> <tr><td>GrantRevokeRoleStmt</td> <td></td> <td></td></tr> <tr><td>InsertStmt</td> <td></td> <td></td></tr> <tr><td>LoadDataStmt</td> <td></td> <td></td></tr> <tr><td>ResetMetadataStmt</td> <td></td> <td></td></tr> <tr><td>SelectStmt</td> <td></td> <td></td></tr> <tr><td>SetStmt</td> <td></td> <td></td></tr> <tr><td>ShowCreateFunctionStmt</td> <td></td> <td></td></tr> <tr><td>ShowCreateTableStmt</td> <td></td> <td></td></tr> <tr><td>ShowDataSrcsStmt</td> <td></td> <td></td></tr> <tr><td>ShowDbsStmt</td> <td></td> <td></td></tr> <tr><td>ShowFilesStmt</td> <td></td> <td></td></tr> <tr><td>ShowFunctionsStmt</td> <td></td> <td></td></tr> <tr><td>ShowGrantPrincipalStmt</td> <td></td> <td></td></tr> <tr><td>ShowRolesStmt</td> <td></td> <td></td></tr> <tr><td>ShowStatsStmt</td> <td></td> <td></td></tr> <tr><td>ShowTablesStmt</td> <td></td> <td></td></tr> <tr><td>TruncateStmt</td> <td></td> <td></td></tr> <tr><td>UnionStmt</td> <td></td> <td></td></tr> <tr><td>UpdateStmt</td> <td></td> <td></td></tr> <tr><td>UseStmt</td> <td></td> <td></td></tr> <tr><td>ValuesStmt</td> <td></td> <td></td></tr></tbody></table> <h3 id="backend"><a href="#backend" class="header-anchor">$</a> Backend</h3> <h4 id="be-src-rpc-tacceptqueueserver-cc"><a href="#be-src-rpc-tacceptqueueserver-cc" class="header-anchor">$</a> be/src/rpc/TAcceptQueueServer.cc</h4> <p>Impala中所有Thrift Server处理连接的逻辑都在这个类里，包括HiverServer2 Server，Beeswax Server等。</p> <p>在TAcceptQueueServer构造函数中进行一些初始化：</p> <table><thead><tr><th>参数</th> <th>描述</th></tr></thead> <tbody><tr><td>processor</td> <td>Thrift框架相关</td></tr> <tr><td>serverTransport</td> <td>Thrift框架相关</td></tr> <tr><td>transportFactory</td> <td>Thrift框架相关</td></tr> <tr><td>protocolFactory</td> <td>Thrift框架相关</td></tr> <tr><td>threadFactory</td> <td>用于创建task线程</td></tr> <tr><td>name</td> <td>服务名</td></tr> <tr><td>maxTasks</td> <td>处理连接逻辑的最大task数</td></tr> <tr><td>queue_timeout_ms</td> <td>在accept之后，建立task之前的超时时间</td></tr> <tr><td>idle_poll_period_ms</td> <td>等待客户端socket超时的时间</td></tr></tbody></table> <p>Thrift Server的启动和接受请求以及停止逻辑都在TAcceptQueueServer::serve()中：</p> <ol><li>启动端口监听</li> <li>创建用于accept请求的线程池connection_setup_pool，并调用Init()方法进行初始化。</li> <li>当没有stop时，在循环中执行：
<ol><li>接受一个client的请求，并封装为TAcceptQueueEntry</li> <li>调用connection_setup_pool.Offer()入队</li></ol></li> <li>当stop时，关闭serverTransport_和连接池connection_setup_pool，等待tasks队列中所有任务执行完毕。</li></ol> <p>一个客户端请求被accept之后，主流程就会启动一个服务线程异步地处理客户端的请求，主要逻辑在TAcceptQueueServer::SetupConnection()中：</p> <ol><li>创建TAcceptQueueServer::Task，并创建一个对应的线程</li> <li>当task数量超过maxTasks限制时，出让时间片等待；如果等待超时则清理资源并退出。</li> <li>当task数量没有超过maxTasks限制，或者提前被唤醒时，则将task加入tasks列表，并启动线程。</li></ol> <p>服务线程的的主要逻辑在TAcceptQueueServer::Task::run()中：</p> <ol><li>调用eventHandler-&gt;processContext()处理上下文</li> <li>处理客户端的请求，或者调用peek()阻塞等待客户端的请求</li></ol> <p>可以看出这个类里主要有两个线程池/线程集：</p> <table><thead><tr><th>名称</th> <th>connection_setup_pool</th> <th>maxTasks</th></tr></thead> <tbody><tr><td>描述</td> <td>负责接受请求并分配服务线程</td> <td>负责处理客户端的请求</td></tr> <tr><td>线程最大数</td> <td>由FLAGS_accepted_cnxn_setup_thread_pool_size设置，默认值是2</td> <td>由构造函数参数传入</td></tr> <tr><td>队列长度</td> <td>由FLAGS_accepted_cnxn_queue_depth设置，默认值是10000</td> <td>无限制</td></tr></tbody></table> <p>Impala之所以要自定义一个TServer，就是想将accept线程和setupConnection线程解耦，从而提高accept的吞吐量。FLAGS_accepted_cnxn_queue_depth默认值是10000，也解释了21050端口的连接数量超过fe_service_thread后为什么会阻塞而不会报错的原因。</p> <p>其中还记录了一些metric：</p> <table><thead><tr><th>名称</th> <th>类型</th> <th>key</th> <th>描述</th></tr></thead> <tbody><tr><td>queue_size_metric_</td> <td>Gauge</td> <td>&quot;.connection-setup-queue-size&quot;</td> <td>connection_setup_pool队列大小</td></tr> <tr><td>timedout_cnxns_metric_</td> <td>Gauge</td> <td>&quot;.timedout-cnxn-requests&quot;</td> <td>建立连接超时的请求数量</td></tr> <tr><td>cnxns_setup_time_us_metric_</td> <td>Histogram</td> <td>&quot;.connection-setup-time&quot;</td> <td>建立连接的时间统计</td></tr> <tr><td>thread_wait_time_us_metric_</td> <td>Histogram</td> <td>&quot;.svc-thread-wait-time&quot;</td> <td>建立连接到处理请求的时间统计</td></tr></tbody></table> <p>参考：<a href="https://issues.apache.org/jira/browse/IMPALA-4135" target="_blank" rel="noopener noreferrer">IMPALA-4135<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="be-src-statestore-statestore-cc"><a href="#be-src-statestore-statestore-cc" class="header-anchor">$</a> be/src/statestore/statestore.cc</h4> <h4 id="be-src-statestore-statestore-subscriber-cc"><a href="#be-src-statestore-statestore-subscriber-cc" class="header-anchor">$</a> be/src/statestore/statestore-subscriber.cc</h4> <p><code>Statestored</code>类似于一个在内存中维护着一组 <code>Topic</code>的消息队列，但是和常见消息队列的客户端有<code>Producer</code>和<code>Consumer</code>不同的是，它的客户端只有一个<code>Subscriber</code>角色。</p> <p>如下图所示，<code>Subscriber</code>通过交换<code>Topic</code>更新消息定期与<code>Statestored</code>通信：<code>Subscriber</code>首先向<code>Statestored</code>d注册<code>Topic</code>，<code>Statestored</code>向<code>Subscriber</code>发送其订阅的<code>Topic</code>列表的更新，<code>Subscriber</code>返回<code>Topic</code>的变更。<code>Statestored</code>还会频繁地发送心跳信息以确认连接是有效。如果<code>Subscriber</code>一段时间没有收到<code>Statestored</code>的心跳信息会进入&quot;恢复模式&quot;，不断尝试向<code>Statestored</code>重新注册。</p> <p><img src="/assets/img/image-20231008231411236.1834c107.png" alt="image-20231008231411236"></p> <p><code>Statestored</code>内部维护的数据结构如下图所示：</p> <p><img src="/assets/img/image-20231008231755739.beb2d1fd.png" alt="image-20231008231755739"></p> <h5 id="statestoresubscriber的注册流程"><a href="#statestoresubscriber的注册流程" class="header-anchor">$</a> StatestoreSubscriber的注册流程</h5> <p>StatestoreSubscriber的<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore-subscriber.h#L76-L79" target="_blank" rel="noopener noreferrer">构造函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>主要指明了<code>Statestored</code>的地址和<code>Statestored</code>向<code>Subscriber</code>发送心跳的地址，参数如下：</p> <ol><li>subscriber_id：<code>Subscriber</code>编号</li> <li>heartbeat_address：<code>Statestored</code>向<code>Subscriber</code>发送心跳的地址</li> <li>statestore_address：<code>Statestored</code>的地址</li></ol> <p><code>Subscriber</code>在<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore-subscriber.cc#L158-L177" target="_blank" rel="noopener noreferrer">AddTopic()函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中将<code>Topic</code>相关信息添加到内部的topic_registrations_结构中，AddTopic()参数跟<a href="https://github.com/apache/impala/blob/4.2.0/common/thrift/StatestoreService.thrift#L161-L180" target="_blank" rel="noopener noreferrer">TTopicRegistration<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的结构基本是一一对应的：</p> <ol><li>topic_id：<code>Topic</code>编号</li> <li>is_transient：<code>Subscriber</code>断开连接后Statestored需要删除的消息</li> <li>populate_min_subscriber_topic_version：在<code>Statestored</code>发送给<code>Subscriber</code>的<code>Topic</code>更新中填充min_subscriber_topic_version字段，用于需要确定所有的<code>Subscriber</code>都处理完了某个特定更新的场景</li> <li>filter_prefix：只接收匹配该前缀的消息</li> <li>callback：<code>Subscriber</code>接收到<code>Statestored</code>发送的<code>Topic</code>更新后执行的回调函数</li></ol> <p>AddTopic()之后就可以调用StatestoreSubscriber的Start()函数了，主要完成三件事：</p> <ul><li>启动用于接收<code>Statestored</code>心跳请求的Thrift Server</li> <li>调用Register()函数向<code>Statestored</code>发送注册请求</li> <li>启动检测恢复模式的RecoveryModeChecker线程</li></ul> <p><code>StatestoreSubscriber</code>在<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore-subscriber.cc#L179-L224" target="_blank" rel="noopener noreferrer">Register()函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中向 <code>Statestored</code> 发送注册<code>Topic</code>的请求<a href="https://github.com/apache/impala/blob/4.2.0/common/thrift/StatestoreService.thrift#L182-L194" target="_blank" rel="noopener noreferrer">TRegisterSubscriberRequest<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，将AddTopic()函数中保存的<code>Topic</code>信息topic_registrations发送到<code>Statestored</code>。其中TRegisterSubscriberRequest结构如下：</p> <ol><li>protocol_version：协议版本号</li> <li>subscriber_id：集群唯一的<code>Subscriber</code>编号</li> <li>subscriber_location：<code>Statestored</code>向<code>Subscriber</code>发送心跳的地址</li> <li>topic_registrations：<code>Topic</code>的描述</li></ol> <p>注册请求会返回给客户端一个registration_id用于维持与<code>Statestored</code>心跳时候的校验。</p> <h5 id="statestored接收subscriber注册的流程"><a href="#statestored接收subscriber注册的流程" class="header-anchor">$</a> Statestored接收Subscriber注册的流程</h5> <p>当<code>Statestored</code> 接收到<code>Subscriber</code>注册请求时：</p> <ol><li>首先依次检查<code>Topic</code>是否存在，不存在则创建</li> <li>如果<code>Subscriber</code>已经注册过，则取消之前的注册，包括清除之前<code>Subscriber</code>关联的连接，failure_detector_，metric以及所有的transient记录。</li> <li>把subscriber_id，registration_id封装成<code>ScheduledSubscriberUpdate</code>，放入三个线程池队列中进行调度。</li></ol> <p><code>Statestored</code>中分了三个独立的线程池来保证互相之间不会阻塞：</p> <ul><li>subscriber_topic_update_threadpool_：负责<code>Topic</code>更新</li> <li>subscriber_priority_topic_update_threadpool_：优先<code>Topic</code>更新，优先<code>Topic</code>指的是数据量很小但是对延迟很敏感的<code>Topic</code></li> <li>subscriber_heartbeat_threadpool_：用于维持心跳检测</li></ul> <p>如何实现三个线程池周期性调度的呢？后面的流程可以看到每次执行任务之后又会往线程池队列中提交一个新的任务。</p> <h5 id="statestored向subscriber发送heartbeat请求"><a href="#statestored向subscriber发送heartbeat请求" class="header-anchor">$</a> Statestored向Subscriber发送Heartbeat请求</h5> <p><code>Subscriber</code>注册后相关任务放入<code>Statestored</code>线程池中，线程池立即会向<code>Subscriber</code>发送一个Heartbeat请求，具体的处理逻辑在<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore.cc#L884-L1011" target="_blank" rel="noopener noreferrer">DoSubscriberUpdate()函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中：</p> <ol><li>检查<code>Statestored</code>侧的<code>Subscriber</code>结构是否存在，不存在意味着<code>Subscriber</code>已经重新发送了注册请求，此次心跳对应的旧<code>Subscriber</code>结构已经被删除</li> <li>每次的<code>ScheduledSubscriberUpdate</code>记录了一个deadline时间点，执行线程通过sleep达到延迟相应时间段的目的</li> <li>向<code>Subscriber</code>发送Heartbeat请求：
<ol><li>如果成功则记录timestamp用于监测，同时计算下一次heartbeat的dealine，封装成ScheduledSubscriberUpdate，放入线程池的队列</li> <li>如果失败了则取消注册的<code>Subscriber</code></li></ol></li></ol> <h5 id="subscriber的失败检查和恢复流程"><a href="#subscriber的失败检查和恢复流程" class="header-anchor">$</a> Subscriber的失败检查和恢复流程</h5> <p>在<code>StatestoreSubscriber</code>的构造函数中初始化了一个<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore-subscriber.cc#L131" target="_blank" rel="noopener noreferrer">TimeoutFailureDetector<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，TimeoutFailureDetector中维护了StatestoreSubscriber<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore-subscriber.cc#L357-L366" target="_blank" rel="noopener noreferrer">最近一次收到心跳请求的时间<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，同时StatestoreSubscriber会启动线程周期性地（每5秒）检查最后一次收到心跳请求的时间间隔，如果超过一定的阈值（默认30秒）则认为与<code>Statestored</code>的连接已经断开并进入恢复模式，恢复线程会在此过程中加锁，同时在死循环中不断地重试注册过程，流程见<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore-subscriber.cc#L288-L339" target="_blank" rel="noopener noreferrer">RecoveryModeChecker()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 。</p> <h5 id="statestored向subscriber发送updatestate请求"><a href="#statestored向subscriber发送updatestate请求" class="header-anchor">$</a> Statestored向Subscriber发送UpdateState请求</h5> <p>整体流程和<code>Statestored</code>向<code>Subscriber</code>发送Heartbeat请求的流程类似，其中<code>Statestored</code>是如何构建发送给<code>Subscriber</code>的增量更新呢？</p> <p>在<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore.cc#L242-L292" target="_blank" rel="noopener noreferrer">Statestore::Topic::BuildDelta()函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中实现了<code>Statestored</code>侧构建增量更新的逻辑：</p> <ol><li>将记录的last_processed_version设置到TTopicDelta的from_version字段</li> <li><code>topic_update_log_</code>中按版本号记录了消息，在<code>topic_update_log_</code>中首先定位到last_processed_version的条目，然后依次将剩余的消息条目加入增量更新TTopicDelta列表中。如果是全量更新的话则忽略标记为删除的消息，前缀匹配也是在这一步完成的。</li> <li>设置TTopicDelta的to_version字段</li></ol> <p>在<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore.cc#L771-L812" target="_blank" rel="noopener noreferrer">GatherTopicUpdates()函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中进行了TTopicDelta的min_subscriber_topic_version字段的处理。</p> <h5 id="subscriber的接收updatestate请求流程"><a href="#subscriber的接收updatestate请求流程" class="header-anchor">$</a> Subscriber的接收UpdateState请求流程</h5> <p>在<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore-subscriber.cc#L368-L493" target="_blank" rel="noopener noreferrer">UpdateState()函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中对<code>Statestored</code>发来的更新请求进行了处理：</p> <ol><li>首先对lock_尝试加锁，如果加锁失败则略过本次更新。</li> <li>然后依次对所有<code>Topic</code>对应的update_lock尝试加锁，加锁失败同样会略过本次更新。</li> <li>之后依次校验<code>Statestored</code>期望的<code>Topic</code>版本号是否能对应上，如果对应不上则标记该<code>Topic</code>一个from_version，等待<code>Statestored</code>下次发送一个正确的<code>Topic</code>版本范围。同时依次调用callback函数对增量更新进行处理，收集增量的更新并返回给<code>Statestored</code>。</li></ol> <p>这块代码在设计的时候着重考虑了处理的轻量化，以避免造成消息发送的延迟过高。</p> <h5 id="statestored处理subscriber对updatestate请求的响应"><a href="#statestored处理subscriber对updatestate请求的响应" class="header-anchor">$</a> Statestored处理Subscriber对UpdateState请求的响应</h5> <p>在<a href="https://github.com/apache/impala/blob/4.2.0/be/src/statestore/statestore.cc#L666-L769" target="_blank" rel="noopener noreferrer">SendTopicUpdate函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中主要流程如下：</p> <ol><li>更新<code>Subscriber</code>的last_processed_version，以便于下次发送UpdateState请求的时候构建增量更新</li> <li>如果<code>Subscriber</code>发送的消息中设置了from_version，则将last_processed_version重置为from_version</li> <li>如果<code>Subscriber</code>发送的消息中标记了clear_topic_entries，则清空<code>Topic</code></li> <li>将<code>Subscriber</code>发送的消息添加到<code>Statestored</code>本地维护的数据结构中</li></ol> <h5 id="参考-6"><a href="#参考-6" class="header-anchor">$</a> 参考</h5> <p><a href="https://blog.csdn.net/yu616568/article/details/58642789" target="_blank" rel="noopener noreferrer">Impala源码之订阅发布系统的实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="udf开发"><a href="#udf开发" class="header-anchor">$</a> UDF开发</h2> <h3 id="内存申请"><a href="#内存申请" class="header-anchor">$</a> 内存申请</h3> <p>如何申请自动回收的内存，并用类初始化它？</p> <p>Is_null初始为什么是false？(ptr=nullptr, len=0)</p> <p>函数内dst内存一直不会serialize？</p> <p>对象生命周期</p> <p>Roaringbitmap.reset?</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">10/8/2023, 3:46:13 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/bigdata/impala/impala_admin.html" class="prev">
        Impala运维
      </a></span> <span class="next"><a href="/bigdata/impala/impala_community.html">
        Impala社区
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cca92ec1.js" defer></script><script src="/assets/js/2.33a0ea92.js" defer></script><script src="/assets/js/26.9880f9e1.js" defer></script>
  </body>
</html>
